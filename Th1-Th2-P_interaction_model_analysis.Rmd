---
title: "Modeling immune-parasite interactions"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      dev=c('png','tiff'),
                      fig.path='figures/')
```

## Model of Th1-Th2-P interactions

Let's consider a model with a dynamic parasite population that both grows logistically and suffers mortality (or loss of biomass) due to immune response (but only one cell-type).

\begin{align}
\frac{dT_i}{dt} &= b_i + c_i P + \frac{s_i T_i^2}{S_i^2 + T_i^2}\frac{I_{ij}}{I_{ij}+T_j} - m T_i, \\
\frac{dP}{dt} &= b_P P \left(1-\frac{P}{K_P}\right) - a T_2
\end{align}

```{r, echo=FALSE}

full_model = function(t, y, params) {
  s1 <- params["s1"]
  s2 <- params["s2"]
  b1 <- params["b1"]
  b2 <- params["b2"]
  I12 <- params["I12"]
  I21 <- params["I21"]
  S1 <- params["S1"]
  S2 <- params["S2"]
  m <- params["m"]
  c1 <- params["c1"]
  c2 <- params["c2"]
  bp <- params["bp"]
  Kp <- params["Kp"]
  a <- params["a"]
  
  T1 <- y[1]
  T2 <- y[2]
  P <- y[3]
  
  dT1 <- b1 + c1*P + s1*T1^2/(S1^2+T1^2) * I12/(I12+T2) - m*T1
  dT2 <- b2 + c2*P + s2*T2^2/(S2^2+T2^2) * I21/(I21+T1) - m*T2
  dP <- bp*P*(1-P/Kp) - a*T2#*P
  
  list(c(dT1, dT2, dP))
}

cline_model = function(t, y, params) {
  s1 <- params["s1"]
  s2 <- params["s2"]
  b1 <- params["b1"]
  b2 <- params["b2"]
  I12 <- params["I12"]
  I21 <- params["I21"]
  S1 <- params["S1"]
  S2 <- params["S2"]
  m <- params["m"]
  c1 <- params["c1"]
  c2 <- params["c2"]
  bp <- params["bp"]
  Kp <- params["Kp"]
  a <- params["a"]
  P <- params["P"]
  
  T1 <- y[1]
  T2 <- y[2]

  dT1 <- b1 + c1*P + s1*T1^2/(S1^2+T1^2) * I12/(I12+T2) - m*T1
  dT2 <- b2 + c2*P + s2*T2^2/(S2^2+T2^2) * I21/(I21+T1) - m*T2

  list(c(dT1, dT2))
}


library(deSolve)
library(phaseR, quietly=TRUE)
library(magrittr)

## Here is the dynamical outcome for a perfectly balanced immune induction
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=1, c1=1, c2=1, bp=4, Kp=150, a=0.1)
out <- ode(y=c(Th1=5,Th2=5,P=10), times=seq(0,200,1), func=full_model, parms=params) %>% as.data.frame

library(animation)
if(!file.exists("movie5.mp4"))
  saveVideo({ 
    ani.options(interval=0.1)
    for (i in 1:120) {
      #print(i)
      params2 <- c(params, P=out[i,"P"])
      flows <- flowField(derivs, 
                         xlim=c(0,2000),
                         ylim=c(0,2000),
                         parameters=params2,
                         system="two.dim",
                         state.names=c("Th1","Th2"),
                         add=FALSE)
      clines <- nullclines(derivs, 
                           xlim=c(0,2000),
                           ylim=c(0,2000),
                           parameters=params2,
                           col=c(1,2),
                           lwd=2,
                           state.names=c("Th1","Th2"))
      lines(out[1:i,2:3],lwd=2, col="orange")
    }}, video.name="movie5.mp4", other.opts = "-pix_fmt yuv420p -b 300k")


```

However, there is an issue with the above model. 
To see what it is, note the dynamics of the parasite again:
\begin{equation}
\frac{dP}{dt} = b_P P \left(1-\frac{P}{K_P}\right) - a T_2
\end{equation}
I have used a formulation here where the mortality rate of the parasite is actually independent of the parasite density.
The implication of this is that, if the parasite is driven extinct by the immune response, the growth rate is not zero, but rather is negative, leading the system to blow up in an unfortunate way.
You can see that in a simulation where I make the immune induction by the parasite imbalanced, so that the parasite provokes a stronger Th2 immune response than Th1 (Fig. \@ref(fig:imbalancedImmune)).

```{r imbalancedImmune, fig.width=6, fig.height=6, fig.cap="If the parasite's mortality rate is -a*T_2, and the parasite provokes a stronger Th2 immune response, it will be driven extinct and the parasite growth rate will continue to be negative, leading the system to take on negative abundances of parasites and immune cells."}
## Here is the dynamical outcome for a perfectly balanced immune induction
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=1, c1=1, c2=2, bp=4, Kp=150, a=0.1)
out <- ode(y=c(Th1=5,Th2=5,P=10), times=seq(0,200,0.1), func=full_model, parms=params) %>% as.data.frame

par(mfrow=c(1,3), mar=c(4,4,0,0), oma=rep(0.5,4))
with(out[-(175:177),], plot(time, P, type='l'))
with(out[-(175:177),], plot(time, Th1, type='l'))
with(out[-(175:177),], plot(time, Th2, type='l'))
```

We need to modify the parasite dynamics model to the following:
\begin{equation}
\frac{dP}{dt} = b_P P \left(1-\frac{P}{K_P}\right) - a T_2 P
\end{equation}

To get some sense of this model's potential dynamics, it's actually quite useful to do some additional playing around with isocline analyses.
However, in this case, I'm going to look at the isoclines for $P$ and $T_2$, treating $T_1$ as a constant. 
This gives some sense of what's possible, in terms of the outcomes of the relevant immunoparasite dynamics.
One $P$ isocline, given by $dP/dt=0$, is the line
\begin{equation}
T_2 = \frac{b_P (K_P-P)}{a K_P},
\end{equation}
with intercepts at $(T_2=b_P/a, P=0)$ and $(T_2=0, P=K_P)$.
The other is the line $P=0$. 
The $T_2$ isocline, given by $dT_2/dt = 0$, is a cubic function.
You can see a sample configuration for a balanced immune response in Fig. \@ref(fig:T2Pisoclines).
Here there are four intersections between the three nullclines, corresponding to two stable equilibria (a high parasite, low Th2 equilibrium and a low parasite, high Th2 equilibrium), and two unstable equilibria (the equilibrium corresponding to zero parasites and "naive" immune response and an intermediate equilibrium).

```{r T2Pisoclines, fig.height=6, fig.width=6, fig.cap="Isoclines for T2 and P, assuming T1=200."}

full_model = function(t, y, params) {
  s1 <- params["s1"]
  s2 <- params["s2"]
  b1 <- params["b1"]
  b2 <- params["b2"]
  I12 <- params["I12"]
  I21 <- params["I21"]
  S1 <- params["S1"]
  S2 <- params["S2"]
  m <- params["m"]
  c1 <- params["c1"]
  c2 <- params["c2"]
  bp <- params["bp"]
  Kp <- params["Kp"]
  a <- params["a"]
  
  T1 <- y[1]
  T2 <- y[2]
  P <- y[3]
  
  dT1 <- b1 + c1*P + s1*T1^2/(S1^2+T1^2) * I12/(I12+T2) - m*T1
  dT2 <- b2 + c2*P + s2*T2^2/(S2^2+T2^2) * I21/(I21+T1) - m*T2
  dP <- bp*P*(1-P/Kp) - a*T2*P
  
  list(c(dT1, dT2, dP))
}

T2P_cline_model = function(t, y, params) {
  s1 <- params["s1"]
  s2 <- params["s2"]
  b1 <- params["b1"]
  b2 <- params["b2"]
  I12 <- params["I12"]
  I21 <- params["I21"]
  S1 <- params["S1"]
  S2 <- params["S2"]
  m <- params["m"]
  c1 <- params["c1"]
  c2 <- params["c2"]
  bp <- params["bp"]
  Kp <- params["Kp"]
  a <- params["a"]
  T1 <- params["T1"]
  
  T2 <- y[1]
  P <- y[2]

  dT2 <- b2 + c2*P + s2*T2^2/(S2^2+T2^2) * I21/(I21+T1) - m*T2
  dP <- bp*P*(1-P/Kp) - a*T2*P
  
  list(c(dT2, dP))
}

T1T2_cline_model = function(t, y, params) {
  s1 <- params["s1"]
  s2 <- params["s2"]
  b1 <- params["b1"]
  b2 <- params["b2"]
  I12 <- params["I12"]
  I21 <- params["I21"]
  S1 <- params["S1"]
  S2 <- params["S2"]
  m <- params["m"]
  c1 <- params["c1"]
  c2 <- params["c2"]
  bp <- params["bp"]
  Kp <- params["Kp"]
  a <- params["a"]
  P <- params["P"]
  
  T1 <- y[1]
  T2 <- y[2]

  dT1 <- b1 + c1*P + s1*T1^2/(S1^2+T1^2) * I12/(I12+T2) - m*T1
  dT2 <- b2 + c2*P + s2*T2^2/(S2^2+T2^2) * I21/(I21+T1) - m*T2

  list(c(dT1, dT2))
}

library(deSolve)
library(phaseR, quietly=TRUE)

## Three intersections, implying two stable equilibria
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=1, c1=1, c2=1, bp=4, Kp=150, a=0.002)
#for (T1 in c(200, 600, 900, 1100)) {
  params2 <- c(params, T1=200)
  flows <- flowField(T2P_cline_model, 
                     xlim=c(0,2000),
                     ylim=c(0,200),
                     parameters=params2,
                     system="two.dim",
                     state.names=c("Th2","P"),
                     add=FALSE)
  clines <- nullclines(T2P_cline_model, 
                       xlim=c(0,2000),
                       ylim=c(0,200),
                       parameters=params2,
                       col=c(1,2),
                       lwd=2,
                       state.names=c("Th2","P"),
                       add.legend=FALSE)
  eq1 <- findEquilibrium(T2P_cline_model, y0=c(200,130), parameters=params2, system="two.dim", plot.it=TRUE, summary=FALSE)
  eq2 <- findEquilibrium(T2P_cline_model, y0=c(500,100), parameters=params2, system="two.dim", plot.it=TRUE, summary=FALSE)
  eq3 <- findEquilibrium(T2P_cline_model, y0=c(1200,50), parameters=params2, system="two.dim", plot.it=TRUE, summary=FALSE)
  eq4 <- findEquilibrium(T2P_cline_model, y0=c(0,0), parameters=params2, system="two.dim", plot.it=TRUE, summary=FALSE)
  abline(h=0, lwd=2, col=2)
#  legend(x='topright', paste0("T1=",200), bty='n')
  legend(x='topleft', c("Th2 nullclines", "P nullclines"), lwd=2, col=c(1,2), bty='n')
#}



```

From this, however, it's obvious that there are other possible ways that the isoclines can intersect.
In particular, we can consider two ways of modifying the $P$ nullcline by changing the parameters of the parasite growth equation that change the intersections.
If I increase the carrying capacity for the parasite, then there are two equilibria, only one of which is stable, and represents the coexistence of both Th2 and P at a relatively high point (Fig. \@ref(fig:T2Pisocline2).
```{r T2Pisocline2, fig.width=6, fig.height=6, fig.cap="Nullcline configuration and stability if the parasite carrying capacity is increased."}
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=1, c1=1, c2=1, bp=4, Kp=200, a=0.002)
params2 <- c(params, T1=200)
flows <- flowField(T2P_cline_model, 
                   xlim=c(0,2000),
                   ylim=c(0,200),
                   parameters=params2,
                   system="two.dim",
                   state.names=c("Th2","P"),
                   add=FALSE)
clines <- nullclines(T2P_cline_model, 
                     xlim=c(0,2000),
                     ylim=c(0,200),
                     parameters=params2,
                     col=c(1,2),
                     lwd=2,
                     state.names=c("Th2","P"),
                     add.legend=FALSE)
eq3 <- findEquilibrium(T2P_cline_model, y0=c(1200,50), parameters=params2, system="two.dim", plot.it=TRUE, summary=FALSE)
eq4 <- findEquilibrium(T2P_cline_model, y0=c(0,0), parameters=params2, system="two.dim", plot.it=TRUE, summary=FALSE)
abline(h=0, lwd=2, col=2)
#legend(x='topright', paste0("T1=",T1), bty='n')
legend(x='topleft', c("Th2 nullclines", "P nullclines"), lwd=2, col=c(1,2), bty='n')

```

On the other hand, if increase the immune system's killing ability by increasing $a$, then there are two equilibria, one of which is stable, and represents the coexistence of both Th2 and P at a low immune biomass (Fig. \@ref(fig:T2Pisocline3).
```{r T2Pisocline3, fig.width=6, fig.height=6, fig.cap="Nullcline configuration and stability if the immune attack rate is increased."}
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=1, c1=1, c2=1, bp=4, Kp=150, a=0.005)
params2 <- c(params, T1=200)
flows <- flowField(T2P_cline_model, 
                   xlim=c(0,2000),
                   ylim=c(0,200),
                   parameters=params2,
                   system="two.dim",
                   state.names=c("Th2","P"),
                   add=FALSE)
clines <- nullclines(T2P_cline_model, 
                     xlim=c(0,2000),
                     ylim=c(0,200),
                     parameters=params2,
                     col=c(1,2),
                     lwd=2,
                     state.names=c("Th2","P"),
                     add.legend=FALSE)
abline(h=0, lwd=2, col=2)
eq3 <- findEquilibrium(T2P_cline_model, y0=c(200,100), parameters=params2, system="two.dim", plot.it=TRUE, summary=FALSE)
eq4 <- findEquilibrium(T2P_cline_model, y0=c(0,0), parameters=params2, system="two.dim", plot.it=TRUE, summary=FALSE)
#legend(x='topright', paste0("T1=",200), bty='n')
legend(x='topleft', c("Th2 nullclines", "P nullclines"), lwd=2, col=c(1,2), bty='n')

```


The other way that the isocline configuration can be modified is by changing the shape of the Th2 isocline.
In particular, if I lower the "trough" of the function so that it crosses the Th2 axis, there are other dynamical possibilities that appear.
For example, if I reduce the immune loss rate $m$ from 1 to 0.95, I can get this configuration, with 4 equilibria, one of which is stable and represents the stable coexistence of the immune system and parasite with a high Th2 biomass and a low parasite biomass (Fig. \@ref(fig:T2Pisocline4))

```{r T2Pisocline4, fig.width=6, fig.height=6, fig.cap="Nullcline configuration and stability when immune cell loss rate is lower."}
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.95, c1=1, c2=1, bp=4, Kp=150, a=0.002)
params2 <- c(params, T1=200)
flows <- flowField(T2P_cline_model, 
                   xlim=c(0,2000),
                   ylim=c(0,200),
                   parameters=params2,
                   system="two.dim",
                   state.names=c("Th2","P"),
                   add=FALSE)
clines <- nullclines(T2P_cline_model, 
                     xlim=c(0,2000),
                     ylim=c(0,200),
                     parameters=params2,
                     col=c(1,2),
                     lwd=2,
                     state.names=c("Th2","P"),
                     add.legend=FALSE)
abline(h=0, lwd=2, col=2)
eq1 <- findEquilibrium(T2P_cline_model, y0=c(1200,50), parameters=params2, system="two.dim", plot.it=TRUE, summary=FALSE)
eq2 <- findEquilibrium(T2P_cline_model, y0=c(0,0), parameters=params2, system="two.dim", plot.it=TRUE, summary=FALSE)
eq3 <- findEquilibrium(T2P_cline_model, y0=c(700,0), parameters=params2, system="two.dim", plot.it=TRUE, summary=FALSE)
eq4 <- findEquilibrium(T2P_cline_model, y0=c(1200,0), parameters=params2, system="two.dim", plot.it=TRUE, summary=FALSE)
legend(x='topleft', c("Th2 nullclines", "P nullclines"), lwd=2, col=c(1,2), bty='n')

```

If I take that configuration but reduce the carrying capacity of the parasite, then I get the configuration in Fig. \@ref(fig:T2Pisocline5), with six equilibria, two of which are stable and represent the coexistence of the immune system and parasite at either an immune-dominated equilibrium, or a parasite-dominated one.

```{r T2Pisocline5, fig.width=6, fig.height=6, fig.cap="Nullcline configuration and stability when immune cell loss rate is lower and the parasite carrying capacity is decreased."}
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.95, c1=1, c2=1, bp=4, Kp=100, a=0.002)
params2 <- c(params, T1=200)
flows <- flowField(T2P_cline_model, 
                   xlim=c(0,2000),
                   ylim=c(0,200),
                   parameters=params2,
                   system="two.dim",
                   state.names=c("Th2","P"),
                   add=FALSE)
clines <- nullclines(T2P_cline_model, 
                     xlim=c(0,2000),
                     ylim=c(0,200),
                     parameters=params2,
                     col=c(1,2),
                     lwd=2,
                     state.names=c("Th2","P"),
                     add.legend=FALSE)
abline(h=0, lwd=2, col=2)
eq1 <- findEquilibrium(T2P_cline_model, y0=c(1200,50), parameters=params2, system="two.dim", plot.it=TRUE, summary=FALSE)
eq2 <- findEquilibrium(T2P_cline_model, y0=c(0,0), parameters=params2, system="two.dim", plot.it=TRUE, summary=FALSE)
eq3 <- findEquilibrium(T2P_cline_model, y0=c(700,0), parameters=params2, system="two.dim", plot.it=TRUE, summary=FALSE)
eq4 <- findEquilibrium(T2P_cline_model, y0=c(1200,0), parameters=params2, system="two.dim", plot.it=TRUE, summary=FALSE)
eq5 <- findEquilibrium(T2P_cline_model, y0=c(100,100), parameters=params2, system="two.dim", plot.it=TRUE, summary=FALSE)
eq6 <- findEquilibrium(T2P_cline_model, y0=c(600,100), parameters=params2, system="two.dim", plot.it=TRUE, summary=FALSE)

legend(x='topleft', c("Th2 nullclines", "P nullclines"), lwd=2, col=c(1,2), bty='n')

```

If I take that configuration, but increase the immune system's killing ability, then I get the configuration in Fig. \@ref(fig:T2Pisocline6), with five equilibria, two of which are stable and represent the coexistence of the immune system and parasite at an immune-dominated equilibrium or a parasite extinction equilibrium.
This is a particularly interesting case, becuase it represents the two most biologically plausible outcomes of infection.

```{r T2Pisocline6, fig.width=6, fig.height=6, fig.cap="Nullcline configuration and stability when immune cell loss rate is lower and the parasite carrying capacity is decreased, and the immune killing rate is increased."}
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.95, c1=1, c2=1, bp=4, Kp=100, a=0.004)
params2 <- c(params, T1=200)
flows <- flowField(T2P_cline_model, 
                   xlim=c(0,2000),
                   ylim=c(0,200),
                   parameters=params2,
                   system="two.dim",
                   state.names=c("Th2","P"),
                   add=FALSE)
clines <- nullclines(T2P_cline_model, 
                     xlim=c(0,2000),
                     ylim=c(0,200),
                     parameters=params2,
                     col=c(1,2),
                     lwd=2,
                     state.names=c("Th2","P"),
                     add.legend=FALSE)
abline(h=0, lwd=2, col=2)
eq2 <- findEquilibrium(T2P_cline_model, y0=c(0,0), parameters=params2, system="two.dim", plot.it=TRUE, summary=FALSE)
eq3 <- findEquilibrium(T2P_cline_model, y0=c(700,0), parameters=params2, system="two.dim", plot.it=TRUE, summary=FALSE)
eq4 <- findEquilibrium(T2P_cline_model, y0=c(1200,0), parameters=params2, system="two.dim", plot.it=TRUE, summary=FALSE)
eq5 <- findEquilibrium(T2P_cline_model, y0=c(100,100), parameters=params2, system="two.dim", plot.it=TRUE, summary=FALSE)
eq6 <- findEquilibrium(T2P_cline_model, y0=c(600,100), parameters=params2, system="two.dim", plot.it=TRUE, summary=FALSE)

legend(x='topleft', c("Th2 nullclines", "P nullclines"), lwd=2, col=c(1,2), bty='n')

```

Finally, if I increase the parasite's carrying capacity, I get the configuration in Fig. \@ref(fig:T2Pisocline7), with three equilibria, only one of which is plausible and represents parasite extinction.
Contrasting this with the results in Fig. \@ref(fig:T2Pisocline6) is quite interesting, because it indicates that increasing the parasite's carrying capacity can actually put the system into a state where the only possible outcome is an acute infection.
If we think about the model as a model of parasite biomass accumulation, then the total biomass that is possible should actually depend on dose in an important way. 
In other way, the maximum parasite biomass should increase with dose as it increases the number of worms that could potentially reach adulthood. 
Thus, increasing dose (and increasing parasite biomass carrying capacity) can shift the configuration of the system from one where the parasite can persist to one where it cannot.

```{r T2Pisocline7, fig.width=6, fig.height=6, fig.cap="Nullcline configuration and stability when immune cell loss rate is lower and the parasite carrying capacity is decreased, and the immune killing rate is increased."}
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.95, c1=1, c2=1, bp=4, Kp=200, a=0.004)
params2 <- c(params, T1=200)
flows <- flowField(T2P_cline_model, 
                   xlim=c(0,2000),
                   ylim=c(0,200),
                   parameters=params2,
                   system="two.dim",
                   state.names=c("Th2","P"),
                   add=FALSE)
clines <- nullclines(T2P_cline_model, 
                     xlim=c(0,2000),
                     ylim=c(0,200),
                     parameters=params2,
                     col=c(1,2),
                     lwd=2,
                     state.names=c("Th2","P"),
                     add.legend=FALSE)
abline(h=0, lwd=2, col=2)
eq2 <- findEquilibrium(T2P_cline_model, y0=c(0,0), parameters=params2, system="two.dim", plot.it=TRUE, summary=FALSE)
eq3 <- findEquilibrium(T2P_cline_model, y0=c(700,0), parameters=params2, system="two.dim", plot.it=TRUE, summary=FALSE)
eq4 <- findEquilibrium(T2P_cline_model, y0=c(1200,0), parameters=params2, system="two.dim", plot.it=TRUE, summary=FALSE)

legend(x='topleft', c("Th2 nullclines", "P nullclines"), lwd=2, col=c(1,2), bty='n')

```

One way to build an extension to the model would be to more carefully consider the two aspects of parasite growth within the host, which is in terms of the *numbers* of parasites and the *biomass* of those parasites.
The immune system can act to reduce the number of parasites, and it can act to decrease the biomass growth rate of the parasites.
This may be an important extension to consider that more carefully deals with dose in a mechanistic way.

However, it is important to note that in all of the above, I was only considering a single Th1 abundance ($T_1=200$). 
What happens if the parasite is also secreting Th1 cytokines? 
How does the Th2 and P nullcline configuration change as the T1 cell population grows?


```{r}
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.95, c1=1, c2=1, bp=4, Kp=100, a=0.004)

library(animation)
if(!file.exists("movie6.mp4"))
  saveVideo({ 
    ani.options(interval=0.1)
    for (T1 in seq(50,800,50)) {
      #print(i)
      params2 <- c(params, T1=T1)
      flows <- flowField(T2P_cline_model, 
                         xlim=c(0,2000),
                         ylim=c(0,200),
                         parameters=params2,
                         system="two.dim",
                         state.names=c("Th2","P"),
                         add=FALSE)
      clines <- nullclines(T2P_cline_model, 
                           xlim=c(0,2000),
                           ylim=c(0,200),
                           parameters=params2,
                           col=c(1,2),
                           lwd=2,
                           state.names=c("Th2","P"),
                           add.legend=FALSE)
      abline(h=0, lwd=2, col=2)
      eq2 <- findEquilibrium(T2P_cline_model, y0=c(0,0), parameters=params2, system="two.dim", plot.it=TRUE, summary=FALSE)
      eq3 <- findEquilibrium(T2P_cline_model, y0=c(700,0), parameters=params2, system="two.dim", plot.it=TRUE, summary=FALSE)
      eq4 <- findEquilibrium(T2P_cline_model, y0=c(1200,0), parameters=params2, system="two.dim", plot.it=TRUE, summary=FALSE)
      eq5 <- findEquilibrium(T2P_cline_model, y0=c(100,100), parameters=params2, system="two.dim", plot.it=TRUE, summary=FALSE)
      eq6 <- findEquilibrium(T2P_cline_model, y0=c(600,100), parameters=params2, system="two.dim", plot.it=TRUE, summary=FALSE)
      legend(x='topleft', c("Th2 nullclines", "P nullclines"), lwd=2, col=c(1,2), bty='n')
      legend(x='topright', paste0("T1=",T1))
    }}, video.name="movie6.mp4", other.opts = "-pix_fmt yuv420p -b 300k")



```
I will take the configuration shown in Fig. \@ref(fig:T2Pisocline6) and increase the Th1 abundance. 
You can see that, as the Th1 cell population grows, eventually the acute infection equilibrium vanishes.
This suggests that there may be two ways for the parasite to succeed. 
One is by inducing a strong enough Th1 response to eliminate the possibility of an acute infection.
The other is to avoid inducing a strong immune response at all.

<video width="720" height="720" controls>
<source src="/Users/ccressler2/immunoparasite/movie6.mp4" type="video/mp4">
</video>

The challenge here is figuring out what to plot. 
What things are likely to vary among host or parasite genotypes? 
One thing that's fairly easy to do is to look at the parasite isocline to clarify how changing *those* parameters will affect things.
Recall that the intercepts of this linear equation are $(T_2=b_P/a, P=0)$ and $(T_2=0, P=K_P)$.
Thus, changing the carrying capacity for the parasite slides the isocline up the y-axis, keeping the x-intercept fixed. 
The effects of this change will depend, of course, on the relative position of the $T_2$ isocline.
If the $T_2$ isocline intercepts the $T_2$ axis only once (near 0), then increasing the carrying capacity will tend to stabilize high immune, high parasite equilibrium; reducing the carrying capacity will tend to stabilize the low immune, low parasite equilibrium; intermediate carrying capacities can be bistable between these two equilibria.
If the $T_2$ isocline intercepts the $T_2$ axis three times, the the effect of changing the carrying capacity depends quite a lot on where the $P$ isocline intercepts the $T_2$ axis. 
If the $P$ isocline intercepts the $T_2$ axis beyond the third intercept of the $T_2$ isocline, then increasing the carrying capacity will tend to cause the system to stabilize at a high $T_2$, low parasite biomass equilibrium.
Lowering the carrying capacity will cause the system to become bistable between a high $T_2$ and a low $T_2$ equilibrium.
If the $P$ isocline intercepts the $T_2$ axis between the second and third intercepts of the $T_2$ isocline, then the acute infection equilibrium will always be stable, and increasing the carrying capacity will cause that to be the *only* stable equilibrium, whereas lowering the carrying capacity will cause bistability.
If the $P$ isocline intercepts the $T_2$ axis between the first and second intercepts of the $T_2$ isocline, then there will always be bistability between an acute and chronic infection and increasing the carrying capacity will just increase the $P$ and $T_2$ abundances at the chronic equilibrium. 

Of course, it is reasonable to argue that carrying capacity might be fairly irrelevant to most infections, which will never get anywhere near their carrying capacities any way.
In such a case it is more reasonable to ask what might happen as you change either the parasite's growth rate $b_P$ or the immune response's attack rate $a$, which together determine the $T_2$ intercept ($b_P/a$).
Again, this will depend on the number of intercepts of the $T_2$ isocline with the $T_2$ axis. 
If there is a single intercept, then increasing $b_P/a$ will tend to cause the system to become stable at a high $P$, high $T_2$ equilibrium, whereas decreasing it will cause the system to become stable at a low $P$, low $T_2$ equilibrium.
If there are three intercepts, then increasing $b_P/a$ will have similar effects. 
However, if $b_P/a$ is small enough (lower than the third intercept of the $T_2$ isocline), then the acute infection equilibrium will always be stable, a key point.

Thus, understanding the qualitative dynamical possibilities we are interested in (acute versus chronic) requires answering two questions: (1) how many times does the $T_2$ isocline intercept the $T_2$ axis; (2) if that answer is 3, is $b_P/a$ smaller than the third intercept?
Unfortunately, there is essentially no analytical tractability to that question, as we are dealing with a cubic function.
The zeros of a cubic function are complicated and, with a model of this complexity, there are no nice simplifications that make it possible to figure out how many there will be, unfortunately.

The best thing to do in this scenario is just play out how changing the various parameters changes the shape of the isocline.

```{r, echo=FALSE}
##
library(animation)
if(!file.exists("movie7.mp4"))
  saveVideo({ 
    ani.options(interval=0.1)
    params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.95, c1=1, c2=1, bp=4, Kp=200, a=0.004)
    params2 <- c(params, T1=200)
    for (m in seq(0.8,1.2,0.05)) {
      #print(i)
      params2["m"] <- m
      flows <- flowField(T2P_cline_model, 
                         xlim=c(0,2000),
                         ylim=c(0,200),
                         parameters=params2,
                         system="two.dim",
                         state.names=c("Th2","P"),
                         add=FALSE)
      clines <- nullclines(T2P_cline_model, 
                           xlim=c(0,2000),
                           ylim=c(0,200),
                           parameters=params2,
                           col=c(1,2),
                           lwd=2,
                           state.names=c("Th2","P"),
                           add.legend=FALSE)
      legend(x='topleft', c("Th2 nullclines", "P nullclines"), lwd=2, col=c(1,2), bty='n')
      legend(x='topright', paste0("m=",m))
      abline(h=0, lwd=2, col=2)
    }}, video.name="movie7.mp4", other.opts = "-pix_fmt yuv420p -b 300k")

```
Increasing the background immune loss rate increases the height of the peak and the trough of the cubic function. 
This decreases the chances of a stable acute infection equilibrium and makes it more likely that the only stable equilibrium will be one where the parasite persists at a high abundance, with a low abundance of Th2 cells.
<video width="720" height="720" controls>
<source src="/Users/ccressler2/immunoparasite/movie7.mp4" type="video/mp4">
</video>

```{r, echo=FALSE}
## increase the value of c2 
if(!file.exists("movie8.mp4"))
  saveVideo({ 
    ani.options(interval=0.1)
    params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.95, c1=1, c2=1, bp=4, Kp=200, a=0.004)
    params2 <- c(params, T1=200)
    for (c2 in seq(0.5,2,0.05)) {
      #print(i)
      params2["c2"] <- c2
      flows <- flowField(T2P_cline_model, 
                         xlim=c(0,2000),
                         ylim=c(-50,200),
                         parameters=params2,
                         system="two.dim",
                         state.names=c("Th2","P"),
                         add=FALSE)
      clines <- nullclines(T2P_cline_model, 
                           xlim=c(0,2000),
                           ylim=c(-50,200),
                           parameters=params2,
                           col=c(1,2),
                           lwd=2,
                           state.names=c("Th2","P"),
                           add.legend=FALSE)
      legend(x='topleft', c("Th2 nullclines", "P nullclines"), lwd=2, col=c(1,2), bty='n')
      legend(x='topright', paste0("c2=",c2))
      abline(h=0, lwd=2, col=2)
    }}, video.name="movie8.mp4", other.opts = "-pix_fmt yuv420p -b 300k")

```
Increasing the parasite's stimulation of $T_2$ decreases the heights of the peak and trough, but without affecting the intercepts of the isocline with the $T_2$ axis.
Thus, if the acute infection equilibrium is stable (because of the position of the $P$ isocline), increasing the stimulation of the $T_2$ response will tend to destabilize the chronic equilibrium, as you would expect. 
However, if there is bistability between two chronic equilibria (a high parasite and low parasite equilibrium), then you will end up in a situation where only the high $T_2$, low $P$ equilibrium is stable.
Again, this is exactly what you would expect.
<video width="720" height="720" controls>
<source src="/Users/ccressler2/immunoparasite/movie8.mp4" type="video/mp4">
</video>

```{r, echo=FALSE}
## increase the value of c2 
if(!file.exists("movie9.mp4"))
  saveVideo({ 
    ani.options(interval=0.1)
    params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.95, c1=1, c2=1, bp=4, Kp=200, a=0.004)
    params2 <- c(params, T1=200)
    for (s2 in seq(1500,2500,100)) {
      #print(i)
      params2["s2"] <- s2
      flows <- flowField(T2P_cline_model, 
                         xlim=c(0,2000),
                         ylim=c(-50,200),
                         parameters=params2,
                         system="two.dim",
                         state.names=c("Th2","P"),
                         add=FALSE)
      clines <- nullclines(T2P_cline_model, 
                           xlim=c(0,2000),
                           ylim=c(-50,200),
                           parameters=params2,
                           col=c(1,2),
                           lwd=2,
                           state.names=c("Th2","P"),
                           add.legend=FALSE)
      legend(x='topleft', c("Th2 nullclines", "P nullclines"), lwd=2, col=c(1,2), bty='n')
      legend(x='topright', paste0("s2=",s2))
      abline(h=0, lwd=2, col=2)
    }}, video.name="movie9.mp4", other.opts = "-pix_fmt yuv420p -b 300k")

```
Increasing the autostimulation of the $T_2$ response by increasing $s_2$ drastically lowers the peak and trough of the $T_2$ isocline. 
When $s_2$ is small, the only stable equilibrium is one where $P$ is relatively high and $T_2$ is low. 
When $s_2$ is large, the only stable equilibrium is the acute infection equilibrium. 
Again, this is exactly what you would expect.
<video width="720" height="720" controls>
<source src="/Users/ccressler2/immunoparasite/movie9.mp4" type="video/mp4">
</video>

```{r, echo=FALSE}
## increase the value of c2 
if(!file.exists("movie10.mp4"))
  saveVideo({ 
    ani.options(interval=0.1)
    params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.95, c1=1, c2=1, bp=4, Kp=200, a=0.004)
    params2 <- c(params, T1=200)
    for (I21 in seq(6000,14000,500)) {
      #print(i)
      params2["I21"] <- I21
      flows <- flowField(T2P_cline_model, 
                         xlim=c(0,2000),
                         ylim=c(-50,200),
                         parameters=params2,
                         system="two.dim",
                         state.names=c("Th2","P"),
                         add=FALSE)
      clines <- nullclines(T2P_cline_model, 
                           xlim=c(0,2000),
                           ylim=c(-50,200),
                           parameters=params2,
                           col=c(1,2),
                           lwd=2,
                           state.names=c("Th2","P"),
                           add.legend=FALSE)
      legend(x='topleft', c("Th2 nullclines", "P nullclines"), lwd=2, col=c(1,2), bty='n')
      legend(x='topright', paste0("I21=",I21))
      abline(h=0, lwd=2, col=2)
    }}, video.name="movie10.mp4", other.opts = "-pix_fmt yuv420p -b 300k")

```
Increasing the cross-inhibition of $T_2$ by $T_1$ has a relatively small effect (potentially because of the choice of $T_1$), and this effect is primarily on lowering the trough of the $T_2$ isocline. 
Thus increasing the cross-inhibition could actually make an acute infection more likely (e.g., moving from bistability between two chronic equilibria bistability between an acute an a chronic equilibrium). 
That is the only response that's a bit unexpected, although it does explain why bistability requires a large value of the cross-inhibition parameter. 
<video width="720" height="720" controls>
<source src="/Users/ccressler2/immunoparasite/movie10.mp4" type="video/mp4">
</video>

```{r,echo=FALSE, eval=FALSE}
full_model = function(t, y, params) {
  s1 <- params["s1"]
  s2 <- params["s2"]
  b1 <- params["b1"]
  b2 <- params["b2"]
  I12 <- params["I12"]
  I21 <- params["I21"]
  S1 <- params["S1"]
  S2 <- params["S2"]
  m <- params["m"]
  c1 <- params["c1"]
  c2 <- params["c2"]
  bp <- params["bp"]
  Kp <- params["Kp"]
  a <- params["a"]
  
  T1 <- y[1]
  T2 <- y[2]
  P <- y[3]
  
  dT1 <- b1 + c1*P + s1*T1^2/(S1^2+T1^2) * I12/(I12+T2) - m*T1
  dT2 <- b2 + c2*P + s2*T2^2/(S2^2+T2^2) * I21/(I21+T1) - m*T2
  dP <- bp*P*(1-P/Kp) - a*T2*P
  
  list(c(dT1, dT2, dP))
}

T2P_cline_model = function(t, y, params) {
  s1 <- params["s1"]
  s2 <- params["s2"]
  b1 <- params["b1"]
  b2 <- params["b2"]
  I12 <- params["I12"]
  I21 <- params["I21"]
  S1 <- params["S1"]
  S2 <- params["S2"]
  m <- params["m"]
  c1 <- params["c1"]
  c2 <- params["c2"]
  bp <- params["bp"]
  Kp <- params["Kp"]
  a <- params["a"]
  T1 <- params["T1"]
  
  T2 <- y[1]
  P <- y[2]

  dT2 <- b2 + c2*P + s2*T2^2/(S2^2+T2^2) * I21/(I21+T1) - m*T2
  dP <- bp*P*(1-P/Kp) - a*T2*P
  
  list(c(dT2, dP))
}

T1T2_cline_model = function(t, y, params) {
  s1 <- params["s1"]
  s2 <- params["s2"]
  b1 <- params["b1"]
  b2 <- params["b2"]
  I12 <- params["I12"]
  I21 <- params["I21"]
  S1 <- params["S1"]
  S2 <- params["S2"]
  m <- params["m"]
  c1 <- params["c1"]
  c2 <- params["c2"]
  bp <- params["bp"]
  Kp <- params["Kp"]
  a <- params["a"]
  P <- params["P"]
  
  T1 <- y[1]
  T2 <- y[2]

  dT1 <- b1 + c1*P + s1*T1^2/(S1^2+T1^2) * I12/(I12+T2) - m*T1
  dT2 <- b2 + c2*P + s2*T2^2/(S2^2+T2^2) * I21/(I21+T1) - m*T2

  list(c(dT1, dT2))
}

library(deSolve)
params = c(S1=800, S2=800, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=1, c1=1.5, c2=1, bp=4, Kp=80, a=0.004)
params2 <- c(params, T1=500)
flows <- flowField(T2P_cline_model, 
                   xlim=c(0,2000),
                   ylim=c(-50,200),
                   parameters=params2,
                   system="two.dim",
                   state.names=c("Th2","P"),
                   add=FALSE)
clines <- nullclines(T2P_cline_model, 
                     xlim=c(0,2000),
                     ylim=c(-50,200),
                     parameters=params2,
                     col=c(1,2),
                     lwd=2,
                     state.names=c("Th2","P"),
                     add.legend=FALSE)
legend(x='topleft', c("Th2 nullclines", "P nullclines"), lwd=2, col=c(1,2), bty='n')
abline(h=0, lwd=2, col=2)

## Here is a case where increasing dose (keeping Th1, Th2 initial conditions fixed) can lead you from acute to chronic
par(mfcol=c(2,4))
for (P in c(20,40,60,80)) {
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.95, c1=3, c2=2, bp=5, Kp=80, a=0.004)
params2 <- c(params, P=P)
flows <- flowField(T1T2_cline_model, 
                   xlim=c(0,2500),
                   ylim=c(0,2500),
                   parameters=params2,
                   system="two.dim",
                   state.names=c("Th1","Th2"),
                   add=FALSE)
clines <- nullclines(T1T2_cline_model, 
                     xlim=c(0,2500),
                     ylim=c(0,2500),
                     parameters=params2,
                     col=c(1,2),
                     lwd=2,
                     state.names=c("Th1","Th2"),
                     add.legend=FALSE)

params3 <- c(params, T1=5*P)
flows <- flowField(T2P_cline_model, 
                   xlim=c(0,2000),
                   ylim=c(-50,200),
                   parameters=params3,
                   system="two.dim",
                   state.names=c("Th2","P"),
                   add=FALSE)
clines <- nullclines(T2P_cline_model, 
                     xlim=c(0,2000),
                     ylim=c(-50,200),
                     parameters=params3,
                     col=c(1,2),
                     lwd=2,
                     state.names=c("Th2","P"),
                     add.legend=FALSE)

}


par(mfrow=c(2,2), mar=c(4.5,4.5,0.5,0.5), rep(0.5,4))
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=1, c1=3, c2=2, bp=4, Kp=80, a=0.004)
times <- seq(0,50,0.1)
y0 <- c(T1=10,T2=600,P=20)
out <- ode(y0, times, full_model, params)
tail(out)


plot(out[,c(1,4)], type='l')
legend(x='topleft', 'Dose = 20', bty='n')

y0 <- c(T1=Ts,T2=Ts,P=40)
out <- ode(y0, times, full_model, params)
plot(out[,c(1,4)], type='l')
legend(x='topleft', 'Dose = 40', bty='n')

y0 <- c(T1=Ts,T2=Ts,P=80)
out <- ode(y0, times, full_model, params)
plot(out[,c(1,4)], type='l')
legend(x='topleft', 'Dose = 80', bty='n')

y0 <- c(T1=Ts,T2=Ts,P=120)
out <- ode(y0, times, full_model, params)
plot(out[,c(1,4)], type='l')
legend(x='topleft', 'Dose = 120', bty='n')

par(mfrow=c(2,2), mar=c(4.5,4.5,0.5,0.5), rep(0.5,4))
Ts <- 450
times <- seq(0,50,0.1)
y0 <- c(T1=Ts,T2=Ts,P=20)
out <- ode(y0, times, full_model, params)
plot(out[,c(1,3)], type='l')
legend(x='topleft', 'Dose = 20', bty='n')

y0 <- c(T1=Ts,T2=Ts,P=40)
out <- ode(y0, times, full_model, params)
plot(out[,c(1,3)], type='l')
legend(x='topleft', 'Dose = 40', bty='n')

y0 <- c(T1=Ts,T2=Ts,P=80)
out <- ode(y0, times, full_model, params)
plot(out[,c(1,3)], type='l')
legend(x='topleft', 'Dose = 80', bty='n')

y0 <- c(T1=Ts,T2=Ts,P=120)
out <- ode(y0, times, full_model, params)
plot(out[,c(1,3)], type='l')
legend(x='topleft', 'Dose = 120', bty='n')


## Start with a naive immune response
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.95, c1=1, c2=1.3, bp=4, Kp=150, a=0.004)
params2 <- c(params, T1=600)
flows <- flowField(T2P_cline_model, 
                   xlim=c(0,2000),
                   ylim=c(-50,200),
                   parameters=params2,
                   system="two.dim",
                   state.names=c("Th2","P"),
                   add=FALSE)
clines <- nullclines(T2P_cline_model, 
                     xlim=c(0,2000),
                     ylim=c(-50,200),
                     parameters=params2,
                     col=c(1,2),
                     lwd=2,
                     state.names=c("Th2","P"),
                     add.legend=FALSE)
legend(x='topleft', c("Th2 nullclines", "P nullclines"), lwd=2, col=c(1,2), bty='n')
abline(h=0, lwd=2, col=2)


par(mfrow=c(2,2), mar=c(4.5,4.5,0.5,0.5), rep(0.5,4))
Ts <- 20
times <- seq(0,50,0.1)
y0 <- c(T1=Ts,T2=Ts,P=20)
out <- ode(y0, times, full_model, params)
plot(out[,c(1,4)], type='l')
legend(x='topleft', 'Dose = 20', bty='n')

y0 <- c(T1=Ts,T2=Ts,P=40)
out <- ode(y0, times, full_model, params)
plot(out[,c(1,4)], type='l')
legend(x='topleft', 'Dose = 40', bty='n')

y0 <- c(T1=Ts,T2=Ts,P=80)
out <- ode(y0, times, full_model, params)
plot(out[,c(1,4)], type='l')
legend(x='topleft', 'Dose = 80', bty='n')

y0 <- c(T1=Ts,T2=Ts,P=120)
out <- ode(y0, times, full_model, params)
plot(out[,c(1,4)], type='l')
legend(x='topleft', 'Dose = 120', bty='n')


### Immune bias
par(mfrow=c(2,2), mar=c(4.5,4.5,0.5,0.5), rep(0.5,4))
Ts <- 20
times <- seq(0,50,0.1)
y0 <- c(T1=500,T2=200,P=20)
out <- ode(y0, times, full_model, params)
plot(out[,c(1,4)], type='l')
legend(x='topleft', 'Dose = 20', bty='n')

y0 <- c(T1=500,T2=200,P=40)
out <- ode(y0, times, full_model, params)
plot(out[,c(1,4)], type='l')
legend(x='topleft', 'Dose = 40', bty='n')

y0 <- c(T1=500,T2=200,P=80)
out <- ode(y0, times, full_model, params)
plot(out[,c(1,4)], type='l')
legend(x='topleft', 'Dose = 80', bty='n')

y0 <- c(T1=500,T2=200,P=120)
out <- ode(y0, times, full_model, params)
plot(out[,c(1,4)], type='l')
legend(x='topleft', 'Dose = 120', bty='n')



```

I have struggled to find situations where increasing dose can move an infection from acute to chronic. 
The opposite is fairly easy to find. 
I think this is because the model I was using was not incorporating the lessons I learned from the analysis of simpler models. 
In particular, I have induction of immunity as a linear function of parasite biomass, whereas the previous simple model showed that bistability required a nonlinear (saturating) function.
Here is the new model:
\begin{align}
\frac{dT_i}{dt} &= b_i + c_i \frac{P}{C_i + P} + \frac{s_i T_i^2}{S_i^2 + T_i^2}\frac{I_{ij}}{I_{ij}+T_j} - m T_i, \\
\frac{dP}{dt} &= b_P P \left(1-\frac{P}{K_P}\right) - a T_2 P
\end{align}

You can see that bistability in the Th1-Th2 plane is much more impervious to changes in parasite biomass in this model. 
```{r, fig.height=4, fig.width=4, fig.cap="bistability in the Th1-Th2 plane is much more impervious to changes in parasite biomass in this model."}
full_model = function(t, y, params) {
  s1 <- params["s1"]
  s2 <- params["s2"]
  b1 <- params["b1"]
  b2 <- params["b2"]
  I12 <- params["I12"]
  I21 <- params["I21"]
  S1 <- params["S1"]
  S2 <- params["S2"]
  m <- params["m"]
  c1 <- params["c1"]
  c2 <- params["c2"]
  C1 <- params["C1"]
  C2 <- params["C2"]
  bp <- params["bp"]
  Kp <- params["Kp"]
  a <- params["a"]
  
  T1 <- y[1]
  T2 <- y[2]
  P <- y[3]
  
  dT1 <- b1 + c1*P/(C1+P) + s1*T1^2/(S1^2+T1^2) * I12/(I12+T2) - m*T1
  dT2 <- b2 + c2*P/(C2+P) + s2*T2^2/(S2^2+T2^2) * I21/(I21+T1) - m*T2
  dP <- bp*P*(1-P/Kp) - a*T2*P
  
  list(c(dT1, dT2, dP))
}

T2P_cline_model = function(t, y, params) {
  s1 <- params["s1"]
  s2 <- params["s2"]
  b1 <- params["b1"]
  b2 <- params["b2"]
  I12 <- params["I12"]
  I21 <- params["I21"]
  S1 <- params["S1"]
  S2 <- params["S2"]
  m <- params["m"]
  c1 <- params["c1"]
  c2 <- params["c2"]
  C1 <- params["C1"]
  C2 <- params["C2"]
  bp <- params["bp"]
  Kp <- params["Kp"]
  a <- params["a"]
  T1 <- params["T1"]
  
  T2 <- y[1]
  P <- y[2]

  dT2 <- b2 + c2*P/(C2+P) + s2*T2^2/(S2^2+T2^2) * I21/(I21+T1) - m*T2
  dP <- bp*P*(1-P/Kp) - a*T2*P
  
  list(c(dT2, dP))
}

T1T2_cline_model = function(t, y, params) {
  s1 <- params["s1"]
  s2 <- params["s2"]
  b1 <- params["b1"]
  b2 <- params["b2"]
  I12 <- params["I12"]
  I21 <- params["I21"]
  S1 <- params["S1"]
  S2 <- params["S2"]
  m <- params["m"]
  c1 <- params["c1"]
  c2 <- params["c2"]
  C1 <- params["C1"]
  C2 <- params["C2"]
  bp <- params["bp"]
  Kp <- params["Kp"]
  a <- params["a"]
  P <- params["P"]
  
  T1 <- y[1]
  T2 <- y[2]

  dT1 <- b1 + c1*P/(C1+P) + s1*T1^2/(S1^2+T1^2) * I12/(I12+T2) - m*T1
  dT2 <- b2 + c2*P/(C2+P) + s2*T2^2/(S2^2+T2^2) * I21/(I21+T1) - m*T2

  list(c(dT1, dT2))
}

params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.9, c1=100, c2=130, C1=50, C2=50, bp=4, Kp=300, a=0.004)
par(mfrow=c(2,3))
for (P in seq(40,240,40)) {
params2 <- c(params, P=P)
flows <- flowField(T1T2_cline_model, 
                   xlim=c(0,2500),
                   ylim=c(0,2500),
                   parameters=params2,
                   system="two.dim",
                   state.names=c("Th1","Th2"),
                   add=FALSE)
clines <- nullclines(T1T2_cline_model, 
                     xlim=c(0,2500),
                     ylim=c(0,2500),
                     parameters=params2,
                     col=c(1,2),
                     lwd=2,
                     state.names=c("Th1","Th2"),
                     add.legend=FALSE)
legend(x='topright', paste0("P = ", P))

}


```

Here you can see how changing dose alters the configuration of the isoclines, showing the Th1 and Th2 isoclines for a low dose (black and red) and a high dose (blue and green) and initial Th1-Th2 densities where a low dose leads to a chronic infection but a high dose leads to clearance. 
The flows show that, from an initial low dose, the movement in the phase plane is towards increasing Th1-ness and decreasing Th2-ness (grey) whereas an initial high dose flows towards increasing Th1-ness and increasing Th2-ness.
The full picture is shown by pairing the Th1-Th2 isoclines with the Th2-P isoclines.
You can see that, from a low dose, the parasite biomass is initially increasing, whereas from a high dose, the parasite biomass is initially decreasing.
Putting the pictures together: from a low dose, the parasite biomass is increasing and the Th1 response is increasing while the Th2 response is decreasing (due to the fact that the system starts with a Th1 bias that allows the Th1 response to suppress the Th2); at a high dose, the parasite bimoass is decreasing and the Th1 and Th2 response are both increasing (due to the fact that the parasite population is larger, which stimulates the Th2 response).

```{r, fig.height=4, fig.width=4, fig.cap="Here are the isoclines for a low dose (black and red) and a high dose (blue and green) and initial Th1-Th2 densities where a low dose leads to a chronic infection but a high dose leads to clearance. The flows show that, from an initial low dose, the movement in the phase plane is towards increasing Th1-ness and decreasing Th2-ness (grey) whereas an initial high dose flows towards increasing Th1-ness and increasing Th2-ness."}
## Here are the isoclines for a low dose (black and red) and a high dose (blue and green) and initial Th1-Th2 densities where a low dose leads to a chronic infection but a high dose leads to clearance. The flows show that, from an initial low dose, the movement in the phase plane is towards increasing Th1-ness and decreasing Th2-ness (grey) whereas an initial high dose flows towards increasing Th1-ness and increasing Th2-ness.
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.9, c1=100, c2=130, C1=50, C2=50, bp=4, Kp=300, a=0.004)
par(mfrow=c(1,2))
params2 <- c(params, P=40)
flows <- flowField(T1T2_cline_model, 
                   xlim=c(0,2500),
                   ylim=c(0,2500),
                   parameters=params2,
                   system="two.dim",
                   state.names=c("Th1","Th2"),
                   add=FALSE)
clines <- nullclines(T1T2_cline_model, 
                     xlim=c(0,2500),
                     ylim=c(0,2500),
                     parameters=params2,
                     col=c(1,2),
                     lwd=2,
                     state.names=c("Th1","Th2"),
                     add.legend=FALSE)

params2 <- c(params, P=200)
flows <- flowField(T1T2_cline_model, 
                   xlim=c(0,2500),
                   ylim=c(0,2500),
                   parameters=params2,
                   system="two.dim",
                   col="pink",
                   state.names=c("Th1","Th2"),
                   add=TRUE)
clines <- nullclines(T1T2_cline_model, 
                     xlim=c(0,2500),
                     ylim=c(0,2500),
                     parameters=params2,
                     col=c(3,4),
                     lwd=2,
                     state.names=c("Th1","Th2"),
                     add.legend=FALSE)
points(800,500)

params2 <- c(params, T1=800)
flows <- flowField(T2P_cline_model, 
                   xlim=c(0,2500),
                   ylim=c(0,400),
                   parameters=params2,
                   system="two.dim",
                   col="gray",
                   state.names=c("Th2","P"),
                   add=FALSE)
clines <- nullclines(T2P_cline_model, 
                     xlim=c(0,2500),
                     ylim=c(0,400),
                     parameters=params2,
                     col=c(1,2),
                     lwd=2,
                     state.names=c("Th2","P"),
                     add.legend=FALSE)
abline(h=40)
abline(h=200)
abline(v=500)
```

```{r, eval=FALSE, echo=FALSE}
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.9, c1=100, c2=130, C1=50, C2=50, bp=4, Kp=300, a=0.004)
jpeg(filename="Th1-Th2-multistability.jpeg", width=600, height=600, units='px', quality=90)
par(mfrow=c(1,1), mar=c(5,5,1,1), oma=rep(0,4))
params2 <- c(params, P=40)
flows <- flowField(T1T2_cline_model, 
                   xlim=c(0,2100),
                   ylim=c(0,2100),
                   parameters=params2,
                   system="two.dim",
                   state.names=c("Th1","Th2"),
                   add=FALSE, 
                   cex.axis=1.5,
                   cex.lab=1.5)
clines <- nullclines(T1T2_cline_model, 
                     xlim=c(0,2100),
                     ylim=c(0,2100),
                     parameters=params2,
                     col=c(1,2),
                     lwd=4,
                     state.names=c("Th1","Th2"),
                     add.legend=FALSE,
                     cex.lab=1.5)
legend(x='topright', legend=c("Th1 nullclines", "Th2 nullclines"), cex=1.5, lwd=3, col=c(1,2))
eq1 <- findEquilibrium(T1T2_cline_model, y0=c(1,1), parameters=params2, system="two.dim", plot.it=TRUE, summary=FALSE)
eq2 <- findEquilibrium(T1T2_cline_model, y0=c(1200,1200), parameters=params2, system="two.dim", plot.it=FALSE, summary=FALSE)
eq3 <- findEquilibrium(T1T2_cline_model, y0=c(0,1500), parameters=params2, system="two.dim", plot.it=FALSE, summary=FALSE)
eq4 <- findEquilibrium(T1T2_cline_model, y0=c(1500,0), parameters=params2, system="two.dim", plot.it=FALSE, summary=FALSE)
eq5 <- findEquilibrium(T1T2_cline_model, y0=c(500,500), parameters=params2, system="two.dim", plot.it=FALSE, summary=FALSE)
eq6 <- findEquilibrium(T1T2_cline_model, y0=c(500,1), parameters=params2, system="two.dim", plot.it=FALSE, summary=FALSE)
eq7 <- findEquilibrium(T1T2_cline_model, y0=c(1,500), parameters=params2, system="two.dim", plot.it=FALSE, summary=FALSE)
eq8 <- findEquilibrium(T1T2_cline_model, y0=c(1500,500), parameters=params2, system="two.dim", plot.it=FALSE, summary=FALSE)
eq9 <- findEquilibrium(T1T2_cline_model, y0=c(500,1500), parameters=params2, system="two.dim", plot.it=FALSE, summary=FALSE)
points(eq1$ystar[1,1], eq1$ystar[2,1], pch=21, bg=1, cex=2.5)
points(eq2$ystar[1,1], eq2$ystar[2,1], pch=21, bg=1, cex=2.5)
points(eq3$ystar[1,1], eq3$ystar[2,1], pch=21, bg=1, cex=2.5)
points(eq4$ystar[1,1], eq4$ystar[2,1], pch=21, bg=1, cex=2.5)
points(eq5$ystar[1,1], eq5$ystar[2,1], cex=2.5)
points(eq6$ystar[1,1], eq6$ystar[2,1], cex=2.5)
points(eq7$ystar[1,1], eq7$ystar[2,1], cex=2.5)
points(eq8$ystar[1,1], eq8$ystar[2,1], cex=2.5)
points(eq9$ystar[1,1], eq9$ystar[2,1], cex=2.5)

dev.off()

jpeg(filename="Th2-P-multistability.jpeg", width=600, height=600, units='px', quality=90)
par(mfrow=c(1,1), mar=c(5,5,1,1), oma=rep(0,4))
params2 <- c(params, T1=800)
flows <- flowField(T2P_cline_model, 
                   xlim=c(0,2000),
                   ylim=c(0,450),
                   parameters=params2,
                   system="two.dim",
                   col="gray",
                   state.names=c("Th2","P"),
                   add=FALSE,
                   cex.axis=1.5,
                   cex.lab=1.5)
clines <- nullclines(T2P_cline_model, 
                     xlim=c(0,2000),
                     ylim=c(0,450),
                     parameters=params2,
                     col=c(1,2),
                     lwd=4,
                     state.names=c("Th2","P"),
                     points=500,
                     add.legend=FALSE)
abline(h=0, lwd=4, col=2)
legend(x='topright', legend=c("Th2 nullclines", "P nullclines"), cex=1.5, lwd=3, col=c(1,2))
eq1 <- findEquilibrium(T2P_cline_model, y0=c(1200,0), parameters=params2, system="two.dim", plot.it=FALSE, summary=FALSE)
eq2 <- findEquilibrium(T2P_cline_model, y0=c(200,200), parameters=params2, system="two.dim", plot.it=FALSE, summary=FALSE)
eq3 <- findEquilibrium(T2P_cline_model, y0=c(700,0), parameters=params2, system="two.dim", plot.it=FALSE, summary=FALSE)
points(eq1$ystar[1,1], eq1$ystar[2,1], pch=21, bg=1, cex=2.5)
points(eq2$ystar[1,1], eq2$ystar[2,1], pch=21, bg=1, cex=2.5)
points(eq3$ystar[1,1], eq3$ystar[2,1], cex=2.5)
dev.off()

## Variation in parasite dose can generate differences in infection duration
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.9, c1=50, c2=130, C1=50, C2=50, bp=4,Kp=300, a=0.004)
## Start Th1 biased
out10 <- ode(y=c(T1=800,T2=500,P=10), times=seq(0,50,0.1), full_model, params)
out20 <- ode(y=c(T1=800,T2=500,P=20), times=seq(0,50,0.1), full_model, params)
out40 <- ode(y=c(T1=800,T2=500,P=40), times=seq(0,50,0.1), full_model, params)
out80 <- ode(y=c(T1=800,T2=500,P=80), times=seq(0,50,0.1), full_model, params)
## Start balanced
out10.2 <- ode(y=c(T1=500,T2=500,P=10), times=seq(0,50,0.1), full_model, params)
out20.2 <- ode(y=c(T1=500,T2=500,P=20), times=seq(0,50,0.1), full_model, params)
out40.2 <- ode(y=c(T1=500,T2=500,P=40), times=seq(0,50,0.1), full_model, params)
out80.2 <- ode(y=c(T1=500,T2=500,P=80), times=seq(0,50,0.1), full_model, params)


jpeg(filename="Chronic-to-acute-Th1-biased.jpeg", width=600, height=600, units='px', quality=90)
par(mfrow=c(1,1), mar=c(5,5,1,1), oma=rep(0,4))
plot(out10[,c("time","P")], type='l', ylim=c(0,250), xlim=c(0,25), lwd=4, col=gray(0.8), xlab="Age of infection", ylab="Parasite biomass", cex.axis=1.5, cex.lab=1.5)
lines(out20[,c("time","P")], lwd=4, col=gray(0.6))
lines(out40[,c("time","P")], lwd=4, col=gray(0.4))
lines(out80[,c("time","P")], lwd=4, col=gray(0.2))
dev.off()

jpeg(filename="Clearance-only-Th1-Th2-balanced.jpeg", width=600, height=600, units='px', quality=90)
par(mfrow=c(1,1), mar=c(5,5,1,1), oma=rep(0,4))
plot(out10.2[,c("time","P")], type='l', ylim=c(0,250), xlim=c(0,25), lwd=4, col=gray(0.8), xlab="Age of infection", ylab="Parasite biomass", cex.axis=1.5, cex.lab=1.5)
lines(out20.2[,c("time","P")], lwd=4, col=gray(0.6))
lines(out40.2[,c("time","P")], lwd=4, col=gray(0.4))
lines(out80.2[,c("time","P")], lwd=4, col=gray(0.2))
dev.off()


params.2 = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.9, c1=700, c2=0, C1=50, C2=50, bp=4, Kp=250, a=0.004)
## start Th2 biased
out10.3 <- ode(y=c(T1=0,T2=800,P=10), times=seq(0,500,0.1), full_model, params.2)
out20.3 <- ode(y=c(T1=0,T2=800,P=20), times=seq(0,50,0.1), full_model, params.2)
out40.3 <- ode(y=c(T1=0,T2=800,P=40), times=seq(0,50,0.1), full_model, params.2)
out80.3 <- ode(y=c(T1=0,T2=800,P=80), times=seq(0,50,0.1), full_model, params.2)
## start balanced
out10.4 <- ode(y=c(T1=400,T2=400,P=10), times=seq(0,500,0.1), full_model, params.2)
out20.4 <- ode(y=c(T1=400,T2=400,P=20), times=seq(0,50,0.1), full_model, params.2)
out40.4 <- ode(y=c(T1=400,T2=400,P=40), times=seq(0,50,0.1), full_model, params.2)
out80.4 <- ode(y=c(T1=400,T2=400,P=80), times=seq(0,50,0.1), full_model, params.2)

jpeg(filename="Acute-to-chronic-Th2-biased.jpeg", width=600, height=600, units='px', quality=90)
par(mfrow=c(1,1), mar=c(5,5,1,1), oma=rep(0,4))
plot(out10.3[,c("time","P")], type='l', ylim=c(0,250), xlim=c(0,25), lwd=4, col=gray(0.8), xlab="Age of infection", ylab="Parasite biomass", cex.axis=1.5, cex.lab=1.5)
lines(out20.3[,c("time","P")], lwd=4, col=gray(0.6))
lines(out40.3[,c("time","P")], lwd=4, col=gray(0.4))
lines(out80.3[,c("time","P")], lwd=4, col=gray(0.2))
dev.off()

jpeg(filename="Chronic-only-Th1-Th2-balanced.jpeg", width=600, height=600, units='px', quality=90)
par(mfrow=c(1,1), mar=c(5,5,1,1), oma=rep(0,4))
plot(out10.4[,c("time","P")], type='l', ylim=c(0,250), xlim=c(0,25), lwd=4, col=gray(0.8), xlab="Age of infection", ylab="Parasite biomass", cex.axis=1.5, cex.lab=1.5)
lines(out20.4[,c("time","P")], lwd=4, col=gray(0.6))
lines(out40.4[,c("time","P")], lwd=4, col=gray(0.4))
lines(out80.4[,c("time","P")], lwd=4, col=gray(0.2))
dev.off()


```

```{r grant_figure, fig.width=8, fig.height=5, units='in', res=450, fig.cap="Figure for grant proposal."}
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.9, c1=100, c2=130, C1=50, C2=50, bp=4, Kp=300, a=0.004)
params2 <- c(params, T1=800)
eq1 <- findEquilibrium(T2P_cline_model, y0=c(1200,0), parameters=params2, system="two.dim", plot.it=FALSE, summary=FALSE)
eq2 <- findEquilibrium(T2P_cline_model, y0=c(200,200), parameters=params2, system="two.dim", plot.it=FALSE, summary=FALSE)
eq3 <- findEquilibrium(T2P_cline_model, y0=c(700,0), parameters=params2, system="two.dim", plot.it=FALSE, summary=FALSE)

par(mfcol=c(2,3), mar=c(5,5,0.5,0.5), oma=c(0,0,5,0))
flows <- flowField(T2P_cline_model, 
                   xlim=c(0,2000),
                   ylim=c(0,450),
                   parameters=params2,
                   system="two.dim",
                   col="gray",
                   state.names=c("Th2 response","Parasite"),
                   add=FALSE,
                   cex.axis=1.5,
                   cex.lab=1.5)
clines <- nullclines(T2P_cline_model, 
                     xlim=c(0,2000),
                     ylim=c(0,450),
                     parameters=params2,
                     col=c(1,2),
                     lwd=4,
                     state.names=c("Th2 response","Parasite"),
                     points=500,
                     add.legend=FALSE)
lines(c(0,2000), c(0,0), col=2, lwd=4)
legend(x='topleft', legend=c("Th2 nullclines", "P nullclines"), cex=1.25, lwd=3, col=c(1,2), bty='n')
text(x=2000, y=450, "A", cex=1.5, adj=0)
mtext(side=3, line=0.5, "Dynamical Profile of\nImmune-Parasite Interaction", cex=1)
points(eq1$ystar[1,1], eq1$ystar[2,1], pch=21, bg=1, cex=2.5)
points(eq2$ystar[1,1], eq2$ystar[2,1], pch=21, bg=1, cex=2.5)
points(eq3$ystar[1,1], eq3$ystar[2,1], cex=2.5)

params2 <- c(params, P=40)
eq1 <- findEquilibrium(T1T2_cline_model, y0=c(1,1), parameters=params2, system="two.dim", plot.it=FALSE, summary=FALSE)
eq2 <- findEquilibrium(T1T2_cline_model, y0=c(1200,1200), parameters=params2, system="two.dim", plot.it=FALSE, summary=FALSE)
eq3 <- findEquilibrium(T1T2_cline_model, y0=c(0,1500), parameters=params2, system="two.dim", plot.it=FALSE, summary=FALSE)
eq4 <- findEquilibrium(T1T2_cline_model, y0=c(1500,0), parameters=params2, system="two.dim", plot.it=FALSE, summary=FALSE)
eq5 <- findEquilibrium(T1T2_cline_model, y0=c(500,500), parameters=params2, system="two.dim", plot.it=FALSE, summary=FALSE)
eq6 <- findEquilibrium(T1T2_cline_model, y0=c(500,1), parameters=params2, system="two.dim", plot.it=FALSE, summary=FALSE)
eq7 <- findEquilibrium(T1T2_cline_model, y0=c(1,500), parameters=params2, system="two.dim", plot.it=FALSE, summary=FALSE)
eq8 <- findEquilibrium(T1T2_cline_model, y0=c(1500,500), parameters=params2, system="two.dim", plot.it=FALSE, summary=FALSE)
eq9 <- findEquilibrium(T1T2_cline_model, y0=c(500,1500), parameters=params2, system="two.dim", plot.it=FALSE, summary=FALSE)

flows <- flowField(T1T2_cline_model, 
                   xlim=c(0,2100),
                   ylim=c(0,2100),
                   parameters=params2,
                   system="two.dim",
                   state.names=c("Th1 response","Th2 response"),
                   add=FALSE, 
                   cex.axis=1.5,
                   cex.lab=1.5)
clines <- nullclines(T1T2_cline_model, 
                     xlim=c(0,2100),
                     ylim=c(0,2100),
                     parameters=params2,
                     col=c(1,2),
                     lwd=4,
                     state.names=c("Th1 response","Th2 response"),
                     add.legend=FALSE,
                     cex.lab=1.5)
legend(x='topleft', legend=c("Th1 nullclines", "Th2 nullclines"), cex=1, lwd=3, col=c(1,2), bty='n')
text(x=2100, y=2100, "B", cex=1.5, adj=0)
points(eq1$ystar[1,1], eq1$ystar[2,1], pch=21, bg=1, cex=2.5)
points(eq2$ystar[1,1], eq2$ystar[2,1], pch=21, bg=1, cex=2.5)
points(eq3$ystar[1,1], eq3$ystar[2,1], pch=21, bg=1, cex=2.5)
points(eq4$ystar[1,1], eq4$ystar[2,1], pch=21, bg=1, cex=2.5)
points(eq5$ystar[1,1], eq5$ystar[2,1], cex=2.5)
points(eq6$ystar[1,1], eq6$ystar[2,1], cex=2.5)
points(eq7$ystar[1,1], eq7$ystar[2,1], cex=2.5)
points(eq8$ystar[1,1], eq8$ystar[2,1], cex=2.5)
points(eq9$ystar[1,1], eq9$ystar[2,1], cex=2.5)


## Variation in parasite dose can generate differences in infection duration
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.9, c1=50, c2=130, C1=50, C2=50, bp=4,Kp=300, a=0.004)
## Start Th1 biased
out10 <- ode(y=c(T1=800,T2=500,P=10), times=seq(0,50,0.1), full_model, params)
out20 <- ode(y=c(T1=800,T2=500,P=20), times=seq(0,50,0.1), full_model, params)
out40 <- ode(y=c(T1=800,T2=500,P=40), times=seq(0,50,0.1), full_model, params)
out80 <- ode(y=c(T1=800,T2=500,P=80), times=seq(0,50,0.1), full_model, params)
## Start balanced
out10.2 <- ode(y=c(T1=500,T2=500,P=10), times=seq(0,50,0.1), full_model, params)
out20.2 <- ode(y=c(T1=500,T2=500,P=20), times=seq(0,50,0.1), full_model, params)
out40.2 <- ode(y=c(T1=500,T2=500,P=40), times=seq(0,50,0.1), full_model, params)
out80.2 <- ode(y=c(T1=500,T2=500,P=80), times=seq(0,50,0.1), full_model, params)


plot(out10[,c("time","P")], type='l', ylim=c(0,250), xlim=c(0,25), lwd=4, col=gray(0.8), xlab="Age of infection", ylab="Parasite biomass", cex.axis=1.5, cex.lab=1.5)
lines(out20[,c("time","P")], lwd=4, col=gray(0.6))
lines(out40[,c("time","P")], lwd=4, col=gray(0.4))
lines(out80[,c("time","P")], lwd=4, col=gray(0.2))
text(x=2.5, y=240, "C1", cex=1.5, adj=1)
mtext(side=3, line=0.5, "Clearance-Promoting >\nChronicity-Promoting", cex=1)

plot(out10.2[,c("time","P")], type='l', ylim=c(0,250), xlim=c(0,25), lwd=4, col=gray(0.8), xlab="Age of infection", ylab="Parasite biomass", cex.axis=1.5, cex.lab=1.5)
lines(out20.2[,c("time","P")], lwd=4, col=gray(0.6))
lines(out40.2[,c("time","P")], lwd=4, col=gray(0.4))
lines(out80.2[,c("time","P")], lwd=4, col=gray(0.2))
text(x=2.5, y=240, "D1", cex=1.5, adj=1)


params.2 = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.9, c1=700, c2=0, C1=50, C2=50, bp=4, Kp=250, a=0.004)
## start Th2 biased
out10.3 <- ode(y=c(T1=0,T2=800,P=10), times=seq(0,500,0.1), full_model, params.2)
out20.3 <- ode(y=c(T1=0,T2=800,P=20), times=seq(0,50,0.1), full_model, params.2)
out40.3 <- ode(y=c(T1=0,T2=800,P=40), times=seq(0,50,0.1), full_model, params.2)
out80.3 <- ode(y=c(T1=0,T2=800,P=80), times=seq(0,50,0.1), full_model, params.2)
## start balanced
out10.4 <- ode(y=c(T1=400,T2=400,P=10), times=seq(0,500,0.1), full_model, params.2)
out20.4 <- ode(y=c(T1=400,T2=400,P=20), times=seq(0,50,0.1), full_model, params.2)
out40.4 <- ode(y=c(T1=400,T2=400,P=40), times=seq(0,50,0.1), full_model, params.2)
out80.4 <- ode(y=c(T1=400,T2=400,P=80), times=seq(0,50,0.1), full_model, params.2)

par(mar=c(5, 1, 0.5, 4))
plot(out10.4[,c("time","P")], type='l', ylim=c(0,250), xlim=c(0,25), lwd=4, col=gray(0.8), xlab="Age of infection", yaxt="n", cex.axis=1.5, cex.lab=1.5)
axis(2, labels=FALSE, tick=TRUE)
lines(out20.4[,c("time","P")], lwd=4, col=gray(0.6))
lines(out40.4[,c("time","P")], lwd=4, col=gray(0.4))
lines(out80.4[,c("time","P")], lwd=4, col=gray(0.2))
text(x=2.5, y=240, "C2", cex=1.5, adj=1)
mtext(side=3, line=0.5, "Chronicity-Promoting >\nClearance-Promoting", cex=1)
corners = par("usr") #Gets the four corners of plot area (x1, x2, y1, y2)
par(xpd = TRUE) #Draw outside plot area
text(x = corners[2]+3, y = mean(corners[3:4]), "Initial Th1 Bias", srt = 270, cex=1.5)

par(xpd=FALSE)
plot(out10.3[,c("time","P")], type='l', ylim=c(0,250), xlim=c(0,25), lwd=4, col=gray(0.8), xlab="Age of infection", yaxt='n', cex.axis=1.5, cex.lab=1.5)
axis(2, labels=FALSE, tick=TRUE)
lines(out20.3[,c("time","P")], lwd=4, col=gray(0.6))
lines(out40.3[,c("time","P")], lwd=4, col=gray(0.4))
lines(out80.3[,c("time","P")], lwd=4, col=gray(0.2))
text(x=2.5, y=240, "D2", cex=1.5, adj=1)
corners = par("usr") #Gets the four corners of plot area (x1, x2, y1, y2)
par(xpd = TRUE) #Draw outside plot area
text(x = corners[2]+3, y = mean(corners[3:4]), "Initial Th2 Bias", srt = 270, cex=1.5)


```

```{r grant_figure_2, fig.width=5, fig.height=8, units='in', res=450, fig.cap="Figure for grant proposal."}
## Strong negative feedbacks
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.9, c1=50, c2=500, C1=50, C2=50, bp=4,Kp=300, a=0.006)
## Start Th1 biased
out10 <- ode(y=c(T1=800,T2=500,P=10), times=seq(0,50,0.1), full_model, params)
out20 <- ode(y=c(T1=800,T2=500,P=20), times=seq(0,50,0.1), full_model, params)
out40 <- ode(y=c(T1=800,T2=500,P=40), times=seq(0,50,0.1), full_model, params)
out80 <- ode(y=c(T1=800,T2=500,P=80), times=seq(0,50,0.1), full_model, params)
## Start Th2 biased
out10.2 <- ode(y=c(T1=500,T2=800,P=10), times=seq(0,50,0.1), full_model, params)
out20.2 <- ode(y=c(T1=500,T2=800,P=20), times=seq(0,50,0.1), full_model, params)
out40.2 <- ode(y=c(T1=500,T2=800,P=40), times=seq(0,50,0.1), full_model, params)
out80.2 <- ode(y=c(T1=500,T2=800,P=80), times=seq(0,50,0.1), full_model, params)

## Strong chronicity-promoting feedbacks
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.9, c1=50, c2=130, C1=50, C2=50, bp=4,Kp=300, a=0.004)
## Start Th1 biased
out10.3 <- ode(y=c(T1=800,T2=500,P=10), times=seq(0,50,0.1), full_model, params)
out20.3 <- ode(y=c(T1=800,T2=500,P=20), times=seq(0,50,0.1), full_model, params)
out40.3 <- ode(y=c(T1=800,T2=500,P=40), times=seq(0,50,0.1), full_model, params)
out80.3 <- ode(y=c(T1=800,T2=500,P=80), times=seq(0,50,0.1), full_model, params)
## Start Th2 biased
out10.4 <- ode(y=c(T1=500,T2=800,P=10), times=seq(0,50,0.1), full_model, params)
out20.4 <- ode(y=c(T1=500,T2=800,P=20), times=seq(0,50,0.1), full_model, params)
out40.4 <- ode(y=c(T1=500,T2=800,P=40), times=seq(0,50,0.1), full_model, params)
out80.4 <- ode(y=c(T1=500,T2=800,P=80), times=seq(0,50,0.1), full_model, params)

## Strong clearance-promoting feedbacks
params.2 = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.9, c1=700, c2=0, C1=50, C2=50, bp=4, Kp=250, a=0.004)
## start Th1 biased
out10.5 <- ode(y=c(T1=600,T2=400,P=10), times=seq(0,500,0.1), full_model, params.2)
out20.5 <- ode(y=c(T1=600,T2=400,P=20), times=seq(0,50,0.1), full_model, params.2)
out40.5 <- ode(y=c(T1=600,T2=400,P=40), times=seq(0,50,0.1), full_model, params.2)
out80.5 <- ode(y=c(T1=600,T2=400,P=80), times=seq(0,50,0.1), full_model, params.2)
## start Th2 biased
out10.6 <- ode(y=c(T1=0,T2=800,P=10), times=seq(0,500,0.1), full_model, params.2)
out20.6 <- ode(y=c(T1=0,T2=800,P=20), times=seq(0,50,0.1), full_model, params.2)
out40.6 <- ode(y=c(T1=0,T2=800,P=40), times=seq(0,50,0.1), full_model, params.2)
out80.6 <- ode(y=c(T1=0,T2=800,P=80), times=seq(0,50,0.1), full_model, params.2)


## Draw the diagram
par(mfrow=c(3,2), mar=c(4,3,0.5,0.5), oma=c(1,3,1,1))
plot(out10[,c("time","P")], type='l', ylim=c(0,250), xlim=c(0,25), lwd=4, col=gray(0.8), xlab="", ylab="", cex.axis=1.5, cex.lab=1.5)
lines(out20[,c("time","P")], lwd=4, col=gray(0.6))
lines(out40[,c("time","P")], lwd=4, col=gray(0.4))
lines(out80[,c("time","P")], lwd=4, col=gray(0.2))
mtext(side=2, line=3, "Parasite biomass")

plot(out10.2[,c("time","P")], type='l', ylim=c(0,250), xlim=c(0,25), lwd=4, col=gray(0.8), xlab="", ylab="", cex.axis=1.5, cex.lab=1.5)
lines(out20.2[,c("time","P")], lwd=4, col=gray(0.6))
lines(out40.2[,c("time","P")], lwd=4, col=gray(0.4))
lines(out80.2[,c("time","P")], lwd=4, col=gray(0.2))

plot(out10.3[,c("time","P")], type='l', ylim=c(0,250), xlim=c(0,25), lwd=4, col=gray(0.8), xlab="", ylab="", cex.axis=1.5, cex.lab=1.5)
lines(out20.3[,c("time","P")], lwd=4, col=gray(0.6))
lines(out40.3[,c("time","P")], lwd=4, col=gray(0.4))
lines(out80.3[,c("time","P")], lwd=4, col=gray(0.2))
mtext(side=2, line=3, "Parasite biomass")

plot(out10.4[,c("time","P")], type='l', ylim=c(0,250), xlim=c(0,25), lwd=4, col=gray(0.8), xlab="", ylab="", cex.axis=1.5, cex.lab=1.5)
lines(out20.4[,c("time","P")], lwd=4, col=gray(0.6))
lines(out40.4[,c("time","P")], lwd=4, col=gray(0.4))
lines(out80.4[,c("time","P")], lwd=4, col=gray(0.2))

plot(out10.5[,c("time","P")], type='l', ylim=c(0,250), xlim=c(0,25), lwd=4, col=gray(0.8), xlab="", ylab="", cex.axis=1.5, cex.lab=1.5)
lines(out20.5[,c("time","P")], lwd=4, col=gray(0.6))
lines(out40.5[,c("time","P")], lwd=4, col=gray(0.4))
lines(out80.5[,c("time","P")], lwd=4, col=gray(0.2))
mtext(side=2, line=3, "Parasite biomass")

plot(out10.6[,c("time","P")], type='l', ylim=c(0,250), xlim=c(0,25), lwd=4, col=gray(0.8), xlab="", ylab="", cex.axis=1.5, cex.lab=1.5)
lines(out20.6[,c("time","P")], lwd=4, col=gray(0.6))
lines(out40.6[,c("time","P")], lwd=4, col=gray(0.4))
lines(out80.6[,c("time","P")], lwd=4, col=gray(0.2))
mtext(side=1, outer=TRUE, line=-1, "Time since infection")

```


```{r, echo=FALSE, eval=FALSE}
gillespie_sim <- function(tmax, y0, params, seed=NULL) {
  if (!is.null(seed))
    set.seed(seed)
  s1 <- params["s1"]
  s2 <- params["s2"]
  b1 <- params["b1"]
  b2 <- params["b2"]
  I12 <- params["I12"]
  I21 <- params["I21"]
  S1 <- params["S1"]
  S2 <- params["S2"]
  m <- params["m"]
  c1 <- params["c1"]
  c2 <- params["c2"]
  C1 <- params["C1"]
  C2 <- params["C2"]
  bp <- params["bp"]
  Kp <- params["Kp"]
  a <- params["a"]
  
  T1 <- y0[1]
  T2 <- y0[2]
  P <- y0[3]
  
  t <- 0
  
  ## set up storage for everything
  out <- array(0, dim=c(1e6, 4))
  colnames(out) <- c("Time", "Th1", "Th2", "P")
  out[1,] <- c(t, T1, T2, P)
  i <- 2
 
  while (t < tmax) {
    
    ## compute event rates
    prod1 <- b1 + c1*P/(C1+P) + s1*T1^2/(S1^2+T1^2) * I12/(I12+T2) 
    prod2 <- b2 + c2*P/(C2+P) + s2*T2^2/(S2^2+T2^2) * I21/(I21+T1)
    death1 <- m*T1
    death2 <- m*T2
    birthP <- bp*P*(1-P/Kp)
    deathP <- a*T2*P
    rates <- c(prod1, prod2, death1, death2, birthP, deathP)
    
    ## what time does the event happen?
    dt <- rexp(1, rate=sum(rates))
    
    ## update t 
    t <- t + dt
    
    ## "wheel of fortune"
    wheel <- cumsum(rates)/sum(rates)
    
    ## which event happens? Draw a random uniform to determine
    rand <- runif(1)
    
    ## if event==1, a new Th1 cell is produced
    ## if event==2, a new Th2 cell is produced
    ## if event==3, a Th1 cell is destroyed
    ## if event==4, a Th2 cell is destroyed
    ## if event==5, a parasite is "born"
    ## if event==6, a parasite dies
    event <- 1 + sum(rand > wheel)
    if (event==1)
      T1 <- T1 + 1
    else if (event==2)
      T2 <- T2 + 1
    else if (event==3)
      T1 <- T1 - 1
    else if (event==4)
      T2 <- T2 - 1
    else if (event==5)
      P <- P+1
    else P <- P-1
    
    out[i,] <- c(t, T1, T2, P)
    
    i <- i + 1
    #print(out[i,])
    if (i > nrow(out)) ## add more rows
      out <- rbind(out, array(0, dim=c(1e6, 4)))
  }
  out <- out[1:(i-1),]
  return(out)
}

library(magrittr)
library(parallel)

set.seed(1234)
seeds <- floor(runif(40,1,1e5))

## Simulations where increasing dose goes from chronic --> acute
## Do 40 stochastic simulations and compute the time to clearance (with 50 meaning no clearance)
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.9, c1=50, c2=130, C1=50, C2=50, bp=4,Kp=300, a=0.004)
params.2 = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.9, c1=800, c2=60, C1=50, C2=50, bp=4, Kp=300, a=0.004)

doses <- c(10,20,40,80,120)
durations <- array(NA, dim=c(length(seeds), length(doses), 2))
for (i in 1:length(doses)) {
  print(i)
  mclapply(seeds, 
           function(s) {
             out <- gillespie_sim(50, y0=c(T1=800,T2=500,P=doses[i]), params=params, seed=s);
             ifelse(any(out[,"P"]==0), out[min(which(out[,"P"]==0)),"Time"], 50)
           },
           mc.cores=10) %>% unlist -> durations[,i,1]
  mclapply(seeds, 
         function(s) {
           out <- gillespie_sim(50, y0=c(T1=0,T2=800,P=doses[i]), params=params.2, seed=s);
           ifelse(any(out[,"P"]==0), out[min(which(out[,"P"]==0)),"Time"], 50)
         },
         mc.cores=10) %>% unlist -> durations[,i,2]
}

           
## Simulations where increasing dose goes from acute --> chronic


lapply(out.2, function(o) tail(o,1))


par(mfrow=c(2,2), oma=rep(0.5,4), mar=c(4,4,0,0))
plot(out10[,c("time","P")], type='l', ylim=c(0,250), xlim=c(0,25), lwd=3, col=1, xlab="Age of infection", ylab="Parasite biomass")
lines(out20[,c("time","P")], lwd=3, col=2, lty=2)
lines(out40[,c("time","P")], lwd=3, col=2, lty=2)
lines(out80[,c("time","P")], lwd=3, col=4, lty=3)
lines(out120[,c("time","P")], lwd=3, col=5, lty=4)

plot(out10[,c("time","T2")], type='l', ylim=c(0,1200), xlim=c(0,25), lwd=3, col=1, xlab="Age of infection", ylab="Parasite biomass")
lines(out40[,c("time","T2")], lwd=3, col=2, lty=2)
lines(out80[,c("time","T2")], lwd=3, col=4, lty=3)
lines(out120[,c("time","T2")], lwd=3, col=5, lty=4)

plot(out[[5]][,c("Time","P")], type='l', ylim=c(0,250), xlim=c(0,40), lwd=1, xlab="Age of infection", ylab="Parasite biomass")
lines(out[[7]][,c("Time","P")])
lines(out[[20]][,c("Time","P")])

plot(out[[5]][,c("Time","Th2")], type='l', ylim=c(0,1200), xlim=c(0,40), lwd=1, xlab="Age of infection", ylab="Parasite biomass")
lines(out[[7]][,c("Time","Th2")])
lines(out[[20]][,c("Time","Th2")])

lapply()

set.seed(1234)
seeds <- runif(50, 1, 1000) %>% floor

```

```{r, eval=FALSE, echo=FALSE}
full_model = function(t, y, params) {
  s1 <- params["s1"]
  s2 <- params["s2"]
  b1 <- params["b1"]
  b2 <- params["b2"]
  I12 <- params["I12"]
  I21 <- params["I21"]
  S1 <- params["S1"]
  S2 <- params["S2"]
  m <- params["m"]
  c1 <- params["c1"]
  c2 <- params["c2"]
  C1 <- params["C1"]
  C2 <- params["C2"]
  bp <- params["bp"]
  Kp <- params["Kp"]
  a <- params["a"]
  
  T1 <- y[1]
  T2 <- y[2]
  P <- y[3]
  
  dT1 <- b1 + c1*P/(C1+P) + s1*T1^2/(S1^2+T1^2) * I12/(I12+T2) - m*T1
  dT2 <- b2 + c2*P/(C2+P) + s2*T2^2/(S2^2+T2^2) * I21/(I21+T1) - m*T2
  dP <- bp*P*(1-P/Kp) - a*T2*P
  
  list(c(dT1, dT2, dP))
}

T2P_cline_model = function(t, y, params) {
  s1 <- params["s1"]
  s2 <- params["s2"]
  b1 <- params["b1"]
  b2 <- params["b2"]
  I12 <- params["I12"]
  I21 <- params["I21"]
  S1 <- params["S1"]
  S2 <- params["S2"]
  m <- params["m"]
  c1 <- params["c1"]
  c2 <- params["c2"]
  C1 <- params["C1"]
  C2 <- params["C2"]
  bp <- params["bp"]
  Kp <- params["Kp"]
  a <- params["a"]
  T1 <- params["T1"]
  
  T2 <- y[1]
  P <- y[2]

  dT2 <- b2 + c2*P/(C2+P) + s2*T2^2/(S2^2+T2^2) * I21/(I21+T1) - m*T2
  dP <- bp*P*(1-P/Kp) - a*T2*P
  
  list(c(dT2, dP))
}

T1T2_cline_model = function(t, y, params) {
  s1 <- params["s1"]
  s2 <- params["s2"]
  b1 <- params["b1"]
  b2 <- params["b2"]
  I12 <- params["I12"]
  I21 <- params["I21"]
  S1 <- params["S1"]
  S2 <- params["S2"]
  m <- params["m"]
  c1 <- params["c1"]
  c2 <- params["c2"]
  C1 <- params["C1"]
  C2 <- params["C2"]
  bp <- params["bp"]
  Kp <- params["Kp"]
  a <- params["a"]
  P <- params["P"]
  
  T1 <- y[1]
  T2 <- y[2]

  dT1 <- b1 + c1*P/(C1+P) + s1*T1^2/(S1^2+T1^2) * I12/(I12+T2) - m*T1
  dT2 <- b2 + c2*P/(C2+P) + s2*T2^2/(S2^2+T2^2) * I21/(I21+T1) - m*T2

  list(c(dT1, dT2))
}



## Strong negative feedbacks
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.9, c1=50, c2=500, C1=50, C2=50, bp=4,Kp=300, a=0.006)
## Start Th1 biased
out10 <- ode(y=c(T1=800,T2=500,P=10), times=seq(0,50,0.1), full_model, params)
out20 <- ode(y=c(T1=800,T2=500,P=20), times=seq(0,50,0.1), full_model, params)
out40 <- ode(y=c(T1=800,T2=500,P=40), times=seq(0,50,0.1), full_model, params)
out80 <- ode(y=c(T1=800,T2=500,P=80), times=seq(0,50,0.1), full_model, params)
## Start Th2 biased
out10.2 <- ode(y=c(T1=500,T2=800,P=10), times=seq(0,50,0.1), full_model, params)
out20.2 <- ode(y=c(T1=500,T2=800,P=20), times=seq(0,50,0.1), full_model, params)
out40.2 <- ode(y=c(T1=500,T2=800,P=40), times=seq(0,50,0.1), full_model, params)
out80.2 <- ode(y=c(T1=500,T2=800,P=80), times=seq(0,50,0.1), full_model, params)

## Strong chronicity-promoting feedbacks
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.9, c1=50, c2=130, C1=50, C2=50, bp=4,Kp=300, a=0.004)
## Start Th1 biased
out10.3 <- ode(y=c(T1=800,T2=500,P=10), times=seq(0,50,0.1), full_model, params)
out20.3 <- ode(y=c(T1=800,T2=500,P=20), times=seq(0,50,0.1), full_model, params)
out40.3 <- ode(y=c(T1=800,T2=500,P=40), times=seq(0,50,0.1), full_model, params)
out80.3 <- ode(y=c(T1=800,T2=500,P=80), times=seq(0,50,0.1), full_model, params)
## Start Th2 biased
out10.4 <- ode(y=c(T1=500,T2=800,P=10), times=seq(0,50,0.1), full_model, params)
out20.4 <- ode(y=c(T1=500,T2=800,P=20), times=seq(0,50,0.1), full_model, params)
out40.4 <- ode(y=c(T1=500,T2=800,P=40), times=seq(0,50,0.1), full_model, params)
out80.4 <- ode(y=c(T1=500,T2=800,P=80), times=seq(0,50,0.1), full_model, params)

## Strong clearance-promoting feedbacks
params.2 = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.9, c1=700, c2=0, C1=50, C2=50, bp=4, Kp=250, a=0.004)
## start Th1 biased
out10.5 <- ode(y=c(T1=600,T2=400,P=10), times=seq(0,500,0.1), full_model, params.2)
out20.5 <- ode(y=c(T1=600,T2=400,P=20), times=seq(0,50,0.1), full_model, params.2)
out40.5 <- ode(y=c(T1=600,T2=400,P=40), times=seq(0,50,0.1), full_model, params.2)
out80.5 <- ode(y=c(T1=600,T2=400,P=80), times=seq(0,50,0.1), full_model, params.2)
## start Th2 biased
out10.6 <- ode(y=c(T1=0,T2=800,P=10), times=seq(0,500,0.1), full_model, params.2)
out20.6 <- ode(y=c(T1=0,T2=800,P=20), times=seq(0,50,0.1), full_model, params.2)
out40.6 <- ode(y=c(T1=0,T2=800,P=40), times=seq(0,50,0.1), full_model, params.2)
out80.6 <- ode(y=c(T1=0,T2=800,P=80), times=seq(0,50,0.1), full_model, params.2)


## One problem with the above models can be seen by actually looking at the immune dynamics, e.g.,
plot(out10.3[,c("time","T2")], type='l') 
## it seems pretty unrealistic that the number of Th2 cells would actually be decreasing the entire time.

## What if you start the system at the equilibria reached above, and then ask what happens with changes in dose?
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.9, c1=50, c2=130, C1=50, C2=50, bp=4,Kp=300, a=0.004)
## Both of these lead to chronic infections
out10.7 <- ode(y=c(T1=unname(out10.3[501,'T1']),T2=unname(out10.3[501,'T2']),P=10), times=seq(0,50,0.1), full_model, params)
out80.7 <- ode(y=c(T1=unname(out10.3[501,'T1']),T2=unname(out10.3[501,'T2']),P=80), times=seq(0,50,0.1), full_model, params)

## Both of these lead to acute infections
out10.8 <- ode(y=c(T1=unname(out80.3[501,'T1']),T2=unname(out80.3[501,'T2']),P=10), times=seq(0,50,0.1), full_model, params)
out80.8 <- ode(y=c(T1=unname(out80.3[501,'T1']),T2=unname(out80.3[501,'T2']),P=80), times=seq(0,50,0.1), full_model, params)


## Key takeaway from these models is that the initial state of the immune system really matters a lot more than the initial state of the parasite. E.g., if chronicity-promoting feedback loops are strong, but the system starts strongly Th1 biased, their strength doesn't matter.

## Unless... what if the parasite only promotes Th2? No, this isn't going to work either, because if the parasite strongly promotes Th2, once it's population size gets large, it will eventually tip the system towards Th2. It has to promote both.
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.9, c1=0, c2=160, C1=50, C2=50, bp=4, Kp=300, a=0.004)
out10.7 <- ode(y=c(T1=unname(out10.3[501,'T1']),T2=unname(out10.3[501,'T2']),P=10), times=seq(0,50,0.1), full_model, params)
out80.7 <- ode(y=c(T1=unname(out10.3[501,'T1']),T2=unname(out10.3[501,'T2']),P=80), times=seq(0,50,0.1), full_model, params)
tail(out10.7)
tail(out80.7)

## The key thing to think about empirically is the following: what puts individuals in different initial immune states? Presumably, from a mathematical perspective, this should come mainly from differences in the value of b1 and b2. 
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=100, b2=100, I12=10000, I21=10000, m=0.9, c1=50, c2=180, C1=50, C2=50, bp=4,Kp=300, a=0.004)
out0.1 <- ode(y=c(T1=100,T2=100,P=0), times=seq(0,50,0.1), full_model, params)
tail(out0.1)

## Start with a more realistic level of bias (because of differences in background exposure that presumably persist during the infection)0
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=130, b2=80, I12=10000, I21=10000, m=0.9, c1=50, c2=130, C1=50, C2=50, bp=4,Kp=300, a=0.004)
out0.2 <- ode(y=c(T1=100,T2=100,P=0), times=seq(0,50,0.1), full_model, params)
tail(out0.2)

## Here's an example of how much the initial state of the immune system matters (and also the initial background immune stimulation).
## With this set of parameter values, at the moment of infection, the immune system has only a slight Th1 bias that is quickly overcome by the introduction of parasites, leading to rapid clearance of the infection.
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=120, b2=80, I12=1000, I21=1000, m=0.9, c1=50, c2=130, C1=50, C2=50, bp=4,Kp=300, a=0.004)
out0.2 <- ode(y=c(T1=100,T2=100,P=0), times=seq(0,50,0.1), full_model, params)
tail(out0.2)
out10.8 <- ode(y=c(T1=unname(out0.2[501,'T1']),T2=unname(out0.2[501,'T2']),P=10), times=seq(0,50,0.1), full_model, params)
out80.8 <- ode(y=c(T1=unname(out0.2[501,'T1']),T2=unname(out0.2[501,'T2']),P=80), times=seq(0,50,0.1), full_model, params)
plot(out10.8)
plot(out80.8)

## But with this slight increase in the background Th1 exposure (changing b1 from 120 to 130), the initial state of the immune system is strongly Th1 biased and parasites cannot stimulate the immune sys0tem away from this.
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=130, b2=80, I12=1000, I21=1000, m=0.9, c1=50, c2=130, C1=50, C2=50, bp=4,Kp=300, a=0.004)
out0.2 <- ode(y=c(T1=100,T2=100,P=0), times=seq(0,50,0.1), full_model, params)
tail(out0.2)
out10.8 <- ode(y=c(T1=unname(out0.2[501,'T1']),T2=unname(out0.2[501,'T2']),P=10), times=seq(0,50,0.1), full_model, params)
out80.8 <- ode(y=c(T1=unname(out0.2[501,'T1']),T2=unname(out0.2[501,'T2']),P=80), times=seq(0,50,0.1), full_model, params)
plot(out10.8)
plot(out80.8)

## Another possibility is that the inherent positive and negative effects are unbalanced (e.g., favoring Th2 with s2 > s1 or I12 < I21), but the initial background exposures are unbalanced (This biased)
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=150, b2=80, I12=9000, I21=10000, m=0.9, c1=0, c2=70, C1=20, C2=20, bp=4,Kp=300, a=0.004)
out0.2 <- ode(y=c(T1=100,T2=100,P=0), times=seq(0,50,0.1), full_model, params)
tail(out0.2)
out10.8 <- ode(y=c(T1=unname(out0.2[501,'T1']),T2=unname(out0.2[501,'T2']),P=10), times=seq(0,50,0.1), full_model, params)
out80.8 <- ode(y=c(T1=unname(out0.2[501,'T1']),T2=unname(out0.2[501,'T2']),P=80), times=seq(0,50,0.1), full_model, params)
plot(out10.8)
plot(out80.8)

```


```{r, echo=FALSE, eval=FALSE}
full_model = function(t, y, params) {
  s1 <- params["s1"]
  s2 <- params["s2"]
  b1 <- params["b1"]
  b2 <- params["b2"]
  I12 <- params["I12"]
  I21 <- params["I21"]
  S1 <- params["S1"]
  S2 <- params["S2"]
  m <- params["m"]
  c1 <- params["c1"]
  c2 <- params["c2"]
  C1 <- params["C1"]
  C2 <- params["C2"]
  bp <- params["bp"]
  Kp <- params["Kp"]
  a <- params["a"]
  
  T1 <- y[1]
  T2 <- y[2]
  P <- y[3]
  
  dT1 <- b1 + c1*P/(C1+P) + s1*T1^2/(S1^2+T1^2) * I12/(I12+T2) - m*T1
  dT2 <- b2 + c2*P/(C2+P) + s2*T2^2/(S2^2+T2^2) * I21/(I21+T1) - m*T2
  dP <- bp*P*(1-P/Kp) - a*T2*P
  
  list(c(dT1, dT2, dP))
}

## Strong chronicity-promoting feedbacks
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.9, c1=50, c2=130, C1=50, C2=50, bp=3, Kp=300, a=0.003)

## Sooooooo sensitive to initial immune conditions
## For i1 = 1300-i2 and i2 < 500, all infections become chronic
## For i2 > 500, all infections are acute
## For i2 = 500, you switch from chronic at low dose to acute at high dose
lapply(seq(100,1200,100), function(i2) sapply(seq(10,80,1), function(p) ode(y=c(T1=1300-i2,T2=i2,P=p), times=seq(0,500,0.1), full_model, params)[5001,"P"] %>% unname)) -> outcomes

## Find the immune value where you switch from chronic to acute for each dose, totalT, and immune induction level
th2Induction <- seq(0,200) %>% as.list
mclapply(th2Induction, 
         function(th2) {
           params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.9, c1=200-th2, c2=th2, C1=50, C2=50, bp=3, Kp=300, a=0.003)
           results <- expand.grid(dose=seq(10,100,1), totalT=seq(200,2000,100), T2=0)
           for (i in 1:nrow(results)) {
             litT2 <- 0
             bigT2 <- results$totalT[i]
             midT2 <- bigT2/2
             P1 = ode(y=c(T1=results$totalT[i]-litT2,T2=litT2,P=results$dose[i]), times=seq(0,100), full_model,params)[101,4]
             P2 = ode(y=c(T1=results$totalT[i]-midT2,T2=midT2,P=results$dose[i]), times=seq(0,100), full_model,params)[101,4]
             P3 = ode(y=c(T1=results$totalT[i]-bigT2,T2=bigT2,P=results$dose[i]), times=seq(0,100), full_model,params)[101,4]
             if(sum(round(c(P1,P2,P3)))==0) 
               results[i,"T2"] <- 0
             else if(all(c(P1,P2,P3) > 20))
               results[i,"T2"] <- results$totalT[i]
             else {
               while(bigT2-midT2 > 1) {
                 if(round(abs(P1-P2)) > round(abs(P2-P3))) { ## acute to chronic switch happens in the first interval
                   ## litT2 stays the same and bigT2 becomes midT2 =>
                   ## P1 remains the same and P3 becomes P2
                   bigT2 <- midT2
                   P3 <- P2
                   ## midT2 is halfway between litT2 and bigT2
                   midT2 <- (bigT2+litT2)/2
                   P2 <- ode(y=c(T1=results$totalT[i]-midT2,T2=midT2,P=results$dose[i]), times=seq(0,100), full_model,params)[101,4]
                 } else {
                   ## bigT2 stays the same and litT2 becomes midT2 =>
                   ## P3 remains the same and P1 becomes P2
                   litT2 <- midT2
                   P1 <- P2
                   ## midT2 is halfway between litT2 and bigT2
                   midT2 <- (bigT2+litT2)/2
                   P2 <- ode(y=c(T1=results$totalT[i]-midT2,T2=midT2,P=results$dose[i]), times=seq(0,100), full_model,params)[101,4]
                 }
               }
               results[i,"T2"] <- midT2
             }
           }
           return(results)
         },
         mc.cores=12) -> output
saveRDS(output, file="Th2_thresholds_between_acute_and_chronic_across_doses_totalT-cells_and_Th1Th2induction.RDS")
```

```{r Th2induction0, fig.height=8, fig.width=12, units='in', fig.cap="Figure showing how initial Th2-ness (x-axis) influences when infections are chronic (left of the solid line) versus acute (right of the solid line), for different initial parasite doses (y-axis) and different initial numbers of T cells (panels). In this figure, the rate of Th1 induction by the parasite is 200 and the rate of Th2 induction is 0."}
output <- readRDS(file="Th2_thresholds_between_acute_and_chronic_across_doses_totalT-cells_and_Th1Th2induction.RDS")
par(mfrow=c(4,5), mar=c(3,3,0.5,0.5), oma=c(2,2,0,0))
for (i in seq(200,2000,100)) {
  r <- subset(output[[1]], totalT==i)
  plot(r$T2/i, r$dose, xlim=c(0,1), ylab="", xlab="", type='l', lwd=3)
  legend(x='topright',legend=i,bty='n')
  if(diff(range(r$T2)) > 1) {
    abline(v=min(r$T2/i), lty=2)
    abline(v=max(r$T2/i), lty=2)
  }
}
```

```{r Th2induction25, fig.height=8, fig.width=12, units='in', fig.cap="Figure showing how initial Th2-ness (x-axis) influences when infections are chronic (left of the solid line) versus acute (right of the solid line), for different initial parasite doses (y-axis) and different initial numbers of T cells (panels). In this figure, the rate of Th1 induction by the parasite is 175 and the rate of Th2 induction is 25."}
par(mfrow=c(4,5), mar=c(3,3,0.5,0.5), oma=c(2,2,0,0))
for (i in seq(200,2000,100)) {
  r <- subset(output[[26]], totalT==i)
  plot(r$T2/i, r$dose, xlim=c(0,1), ylab="", xlab="", type='l', lwd=3)
  legend(x='topright',legend=i,bty='n')
  if(diff(range(r$T2)) > 1) {
    abline(v=min(r$T2/i), lty=2)
    abline(v=max(r$T2/i), lty=2)
  }
}
```

```{r Th2induction50, fig.height=8, fig.width=12, units='in', fig.cap="Figure showing how initial Th2-ness (x-axis) influences when infections are chronic (left of the solid line) versus acute (right of the solid line), for different initial parasite doses (y-axis) and different initial numbers of T cells (panels). In this figure, the rate of Th1 induction by the parasite is 150 and the rate of Th2 induction is 50."}
par(mfrow=c(4,5), mar=c(3,3,0.5,0.5), oma=c(2,2,0,0))
for (i in seq(200,2000,100)) {
  r <- subset(output[[51]], totalT==i)
  plot(r$T2/i, r$dose, xlim=c(0,1), ylab="", xlab="", type='l', lwd=3)
  legend(x='topright',legend=i,bty='n')
  if(diff(range(r$T2)) > 1) {
    abline(v=min(r$T2/i), lty=2)
    abline(v=max(r$T2/i), lty=2)
  }
}
```

```{r Th2induction75, fig.height=8, fig.width=12, units='in', fig.cap="Figure showing how initial Th2-ness (x-axis) influences when infections are chronic (left of the solid line) versus acute (right of the solid line), for different initial parasite doses (y-axis) and different initial numbers of T cells (panels). In this figure, the rate of Th1 induction by the parasite is 125 and the rate of Th2 induction is 75."}
par(mfrow=c(4,5), mar=c(3,3,0.5,0.5), oma=c(2,2,0,0))
for (i in seq(200,2000,100)) {
  r <- subset(output[[76]], totalT==i)
  plot(r$T2/i, r$dose, xlim=c(0,1), ylab="", xlab="", type='l', lwd=3)
  legend(x='topright',legend=i,bty='n')
  if(diff(range(r$T2)) > 1) {
    abline(v=min(r$T2/i), lty=2)
    abline(v=max(r$T2/i), lty=2)
  }
}
```

```{r Th2induction100, fig.height=8, fig.width=12, units='in', fig.cap="Figure showing how initial Th2-ness (x-axis) influences when infections are chronic (left of the solid line) versus acute (right of the solid line), for different initial parasite doses (y-axis) and different initial numbers of T cells (panels). In this figure, the rate of Th1 induction by the parasite is 100 and the rate of Th2 induction is 100."}
par(mfrow=c(4,5), mar=c(3,3,0.5,0.5), oma=c(2,2,0,0))
for (i in seq(200,2000,100)) {
  r <- subset(output[[101]], totalT==i)
  plot(r$T2/i, r$dose, xlim=c(0,1), ylab="", xlab="", type='l', lwd=3)
  legend(x='topright',legend=i,bty='n')
  if(diff(range(r$T2)) > 1) {
    abline(v=min(r$T2/i), lty=2)
    abline(v=max(r$T2/i), lty=2)
  }
}
```

```{r Th2induction125, fig.height=8, fig.width=12, units='in', fig.cap="Figure showing how initial Th2-ness (x-axis) influences when infections are chronic (left of the solid line) versus acute (right of the solid line), for different initial parasite doses (y-axis) and different initial numbers of T cells (panels). In this figure, the rate of Th1 induction by the parasite is 75 and the rate of Th2 induction is 125."}
par(mfrow=c(4,5), mar=c(3,3,0.5,0.5), oma=c(2,2,0,0))
for (i in seq(200,2000,100)) {
  r <- subset(output[[126]], totalT==i)
  plot(r$T2/i, r$dose, xlim=c(0,1), ylab="", xlab="", type='l', lwd=3)
  legend(x='topright',legend=i,bty='n')
  if(diff(range(r$T2)) > 1) {
    abline(v=min(r$T2/i), lty=2)
    abline(v=max(r$T2/i), lty=2)
  }
}
```

```{r Th2induction150, fig.height=8, fig.width=12, units='in', fig.cap="Figure showing how initial Th2-ness (x-axis) influences when infections are chronic (left of the solid line) versus acute (right of the solid line), for different initial parasite doses (y-axis) and different initial numbers of T cells (panels). In this figure, the rate of Th1 induction by the parasite is 50 and the rate of Th2 induction is 150."}
par(mfrow=c(4,5), mar=c(3,3,0.5,0.5), oma=c(2,2,0,0))
for (i in seq(200,2000,100)) {
  r <- subset(output[[151]], totalT==i)
  plot(r$T2/i, r$dose, xlim=c(0,1), ylab="", xlab="", type='l', lwd=3)
  legend(x='topright',legend=i,bty='n')
  if(diff(range(r$T2)) > 1) {
    abline(v=min(r$T2/i), lty=2)
    abline(v=max(r$T2/i), lty=2)
  }
}
```

```{r Th2induction175, fig.height=8, fig.width=12, units='in', fig.cap="Figure showing how initial Th2-ness (x-axis) influences when infections are chronic (left of the solid line) versus acute (right of the solid line), for different initial parasite doses (y-axis) and different initial numbers of T cells (panels). In this figure, the rate of Th1 induction by the parasite is 25 and the rate of Th2 induction is 175."}
par(mfrow=c(4,5), mar=c(3,3,0.5,0.5), oma=c(2,2,0,0))
for (i in seq(200,2000,100)) {
  r <- subset(output[[176]], totalT==i)
  plot(r$T2/i, r$dose, xlim=c(0,1), ylab="", xlab="", type='l', lwd=3)
  legend(x='topright',legend=i,bty='n')
  if(diff(range(r$T2)) > 1) {
    abline(v=min(r$T2/i), lty=2)
    abline(v=max(r$T2/i), lty=2)
  }
}
```

```{r Th2induction200, fig.height=8, fig.width=12, units='in', fig.cap="Figure showing how initial Th2-ness (x-axis) influences when infections are chronic (left of the solid line) versus acute (right of the solid line), for different initial parasite doses (y-axis) and different initial numbers of T cells (panels). In this figure, the rate of Th1 induction by the parasite is 0 and the rate of Th2 induction is 200."}
par(mfrow=c(4,5), mar=c(3,3,0.5,0.5), oma=c(2,2,0,0))
for (i in seq(200,2000,100)) {
  r <- subset(output[[201]], totalT==i)
  plot(r$T2/i, r$dose, xlim=c(0,1), ylab="", xlab="", type='l', lwd=3)
  legend(x='topright',legend=i,bty='n')
  if(diff(range(r$T2)) > 1) {
    abline(v=min(r$T2/i), lty=2)
    abline(v=max(r$T2/i), lty=2)
  }
}
```

```{r grant_figure_new, fig.height=10, fig.width=10, units='in'}
## Strong negative feedbacks - always acute
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.9, c1=50, c2=500, C1=50, C2=50, bp=4,Kp=300, a=0.006)
out10.1 <- ode(y=c(T1=600,T2=600,P=10), times=seq(0,40,0.1), full_model, params)
out20.1 <- ode(y=c(T1=600,T2=600,P=20), times=seq(0,40,0.1), full_model, params)
out40.1 <- ode(y=c(T1=600,T2=600,P=40), times=seq(0,40,0.1), full_model, params)
out80.1 <- ode(y=c(T1=600,T2=600,P=80), times=seq(0,40,0.1), full_model, params)

## Acute to chronic
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.9, c1=50, c2=150, C1=50, C2=50, bp=3, Kp=300, a=0.003)
out10.2 <- ode(y=c(T1=770,T2=430,P=10), times=seq(0,40,0.1), full_model, params)
out20.2 <- ode(y=c(T1=770,T2=430,P=20), times=seq(0,40,0.1), full_model, params)
out40.2 <- ode(y=c(T1=770,T2=430,P=40), times=seq(0,40,0.1), full_model, params)
out80.2 <- ode(y=c(T1=770,T2=430,P=80), times=seq(0,40,0.1), full_model, params)

## Chronic to acute
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.9, c1=150, c2=50, C1=50, C2=50, bp=3, Kp=300, a=0.003)
out10.3 <- ode(y=c(T1=530,T2=670,P=10), times=seq(0,40,0.1), full_model, params)
out20.3 <- ode(y=c(T1=530,T2=670,P=20), times=seq(0,40,0.1), full_model, params)
out40.3 <- ode(y=c(T1=530,T2=670,P=40), times=seq(0,40,0.1), full_model, params)
out80.3 <- ode(y=c(T1=530,T2=670,P=80), times=seq(0,40,0.1), full_model, params)

par(mfrow=c(3,3), mar=c(2.5,5,1,1), oma=rep(0.5,4))
## Strong negative feedbacks - always acute
plot(out10.1[1:101,c(1,4)], type='l', lwd=3, col=gray(0.7), xlab='', ylab='', ylim=c(0,100), cex.axis=1.5)
mtext(side=2, line=3.5, "Parasite biomass", cex=1.5)
lines(out20.1[1:101,c(1,4)], lwd=3, col=gray(0.5))
lines(out40.1[1:101,c(1,4)], lwd=3, col=gray(0.3))
lines(out80.1[1:101,c(1,4)], lwd=3, col=gray(0.1))

plot(out10.1[1:101,c(1,3)], type='l', lwd=3, col=gray(0.7), xlab='', ylab='', ylim=c(0,1600), cex.axis=1.5)
mtext(side=2, line=3.5, "Th2 response", cex=1.5)
lines(out20.1[1:101,c(1,3)], lwd=3, col=gray(0.5))
lines(out40.1[1:101,c(1,3)], lwd=3, col=gray(0.3))
lines(out80.1[1:101,c(1,3)], lwd=3, col=gray(0.1))

plot(out10.1[1:101,c(1,2)], type='l', lwd=3, col=gray(0.7), xlab='', ylab='', ylim=c(0,1600), cex.axis=1.5)
mtext(side=2, line=3.5, "Th1 response", cex=1.5)
lines(out20.1[1:101,c(1,2)], lwd=3, col=gray(0.5))
lines(out40.1[1:101,c(1,2)], lwd=3, col=gray(0.3))
lines(out80.1[1:101,c(1,2)], lwd=3, col=gray(0.1))

## Acute to chronic
plot(out10.2[1:301,c(1,4)], type='l', lwd=3, col=gray(0.7), xlab='', ylab='', ylim=c(0,250), cex.axis=1.5)
mtext(side=2, line=3.5, "Parasite biomass", cex=1.5)
lines(out20.2[1:301,c(1,4)], lwd=3, col=gray(0.5))
lines(out40.2[1:301,c(1,4)], lwd=3, col=gray(0.3))
lines(out80.2[1:301,c(1,4)], lwd=3, col=gray(0.1))

plot(out10.2[1:301,c(1,3)], type='l', lwd=3, col=gray(0.7), xlab='', ylab='', ylim=c(0,1600), cex.axis=1.5)
mtext(side=2, line=3.5, "Th2 response", cex=1.5)
lines(out20.2[1:301,c(1,3)], lwd=3, col=gray(0.5))
lines(out40.2[1:301,c(1,3)], lwd=3, col=gray(0.3))
lines(out80.2[1:301,c(1,3)], lwd=3, col=gray(0.1))

plot(out10.2[1:301,c(1,2)], type='l', lwd=3, col=gray(0.7), xlab='', ylab='', ylim=c(0,1600), cex.axis=1.5)
mtext(side=2, line=3.5, "Th1 response", cex=1.5)
lines(out20.2[1:301,c(1,2)], lwd=3, col=gray(0.5))
lines(out40.2[1:301,c(1,2)], lwd=3, col=gray(0.3))
lines(out80.2[1:301,c(1,2)], lwd=3, col=gray(0.1))

## Chronic to acute
plot(out10.3[1:301,c(1,4)], type='l', lwd=3, col=gray(0.7), xlab='', ylab='', ylim=c(0,250), cex.axis=1.5)
mtext(side=2, line=3.5, "Parasite biomass", cex=1.5)
lines(out20.3[1:301,c(1,4)], lwd=3, col=gray(0.5))
lines(out40.3[1:301,c(1,4)], lwd=3, col=gray(0.3))
lines(out80.3[1:301,c(1,4)], lwd=3, col=gray(0.1))

plot(out10.3[1:301,c(1,3)], type='l', lwd=3, col=gray(0.7), xlab='', ylab='', ylim=c(0,1600), cex.axis=1.5)
mtext(side=2, line=3.5, "Th2 response", cex=1.5)
lines(out20.3[1:301,c(1,3)], lwd=3, col=gray(0.5))
lines(out40.3[1:301,c(1,3)], lwd=3, col=gray(0.3))
lines(out80.3[1:301,c(1,3)], lwd=3, col=gray(0.1))

plot(out10.3[1:301,c(1,2)], type='l', lwd=3, col=gray(0.7), xlab='', ylab='', ylim=c(0,1600), cex.axis=1.5)
mtext(side=2, line=3.5, "Th1 response", cex=1.5)
lines(out20.3[1:301,c(1,2)], lwd=3, col=gray(0.5))
lines(out40.3[1:301,c(1,2)], lwd=3, col=gray(0.3))
lines(out80.3[1:301,c(1,2)], lwd=3, col=gray(0.1))


```

```{r trickle_infection_figure, fig.height=3.3, fig.width=10, units='in'}
 
## Okay, what if you trickle in the infection?
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.9, c1=50, c2=150, C1=50, C2=50, bp=1, Kp=300, a=0.003)
out60.1 <- ode(y=c(T1=580,T2=620,P=60), times=seq(0,15,0.1), full_model, params)

## 60 but spread out - no clearance
d <- 10
eventdat <- data.frame(var=c("P"),
                       time=seq(2,10,2),
                       value=c(d),
                       method=c("add"))
out60.2 <- ode(y=c(T1=580,T2=620,P=d), times=seq(0,15,0.1), full_model, params, events=list(data=eventdat))

par(mfrow=c(1,3), mar=c(2.5,5,1,1), oma=rep(0.5,4))
plot(out60.1[,c(1,4)], type='l', lwd=3, col=gray(0.7), xlab='', ylab='', ylim=c(0,100), cex.axis=1.5)
mtext(side=2, line=3.5, "Parasite biomass", cex=1.5)
lines(out60.2[,c(1,4)], lwd=3, col=gray(0.4))
#lines(out60.3[,c(1,4)], lwd=3, col=gray(0.1))

plot(out60.1[,c(1,3)], type='l', lwd=3, col=gray(0.7), xlab='', ylab='', ylim=c(0,1600), cex.axis=1.5)
mtext(side=2, line=3.5, "Th2 response", cex=1.5)
lines(out60.2[,c(1,3)], lwd=3, col=gray(0.4))
#lines(out60.3[,c(1,3)], lwd=3, col=gray(0.1))

plot(out60.1[,c(1,2)], type='l', lwd=3, col=gray(0.7), xlab='', ylab='', ylim=c(0,600), cex.axis=1.5)
mtext(side=2, line=3.5, "Th1 response", cex=1.5)
lines(out60.2[,c(1,2)], lwd=3, col=gray(0.4))
#lines(out60.3[,c(1,2)], lwd=3, col=gray(0.1))

# totalT <- 1200
# params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.9, c1=50, c2=150, C1=50, C2=50, bp=1, Kp=200, a=0.001)
# results <- data.frame(dose=seq(50,70,1), T2=0)
# for (i in 1:nrow(results)) {
#   litT2 <- 0
#   bigT2 <- totalT
#   midT2 <- totalT/2
#   print(i)
#   P1 = ode(y=c(T1=totalT-litT2,T2=litT2,P=results$dose[i]), times=seq(0,100), full_model,params)[101,4]
#   P2 = ode(y=c(T1=totalT-midT2,T2=midT2,P=results$dose[i]), times=seq(0,100), full_model,params)[101,4]
#   P3 = ode(y=c(T1=totalT-bigT2,T2=bigT2,P=results$dose[i]), times=seq(0,100), full_model,params)[101,4]
#   if(sum(round(c(P1,P2,P3)))==0) 
#     results[i,"T2"] <- 0
#   else if(all(c(P1,P2,P3) > 10))
#     results[i,"T2"] <- results$totalT[i]
#   else {
#     while(bigT2-midT2 > 1) {
#       if(round(abs(P1-P2)) > round(abs(P2-P3))) { ## acute to chronic switch happens in the first interval
#         ## litT2 stays the same and bigT2 becomes midT2 =>
#         ## P1 remains the same and P3 becomes P2
#         bigT2 <- midT2
#         P3 <- P2
#         ## midT2 is halfway between litT2 and bigT2
#         midT2 <- (bigT2+litT2)/2
#         P2 <- ode(y=c(T1=totalT-midT2,T2=midT2,P=results$dose[i]), times=seq(0,100), full_model,params)[101,4]
#       } else {
#         ## bigT2 stays the same and litT2 becomes midT2 =>
#         ## P3 remains the same and P1 becomes P2
#         litT2 <- midT2
#         P1 <- P2
#         ## midT2 is halfway between litT2 and bigT2
#         midT2 <- (bigT2+litT2)/2
#         P2 <- ode(y=c(T1=totalT-midT2,T2=midT2,P=results$dose[i]), times=seq(0,100), full_model,params)[101,4]
#       }
#     }
#     results[i,"T2"] <- midT2
#   }
# }



```

```{r grant_figure_4, fig.height=12, fig.width=12, units='in', fig.cap="Dose is 60 across all simulations. The first contrast shows a shift towards a chronic infection caused by weakening the negative feedbacks, as might be expected if the system shifts towards tolerance. The second shows a shift towards a chronic infection caused by strengthening the baseline level of Th1 stimulation, thereby increasing the initial Th1ness of the system. }

## Three ways the system can shift towards acute

## Baseline clearance
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.9, c1=50, c2=200, C1=50, C2=50, bp=4,Kp=300, a=0.006)
out1 <- ode(y=c(T1=1,T2=1,P=60), times=seq(0,40,0.1), full_model, params)

## Way #1: weaken the negative feedbacks in the system
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.9, c1=25, c2=75, C1=50, C2=50, bp=4,Kp=300, a=0.001)
out2 <- ode(y=c(T1=1,T2=1,P=60), times=seq(0,40,0.1), full_model, params)

## Way #2: strengthen baseline stimulation of the immune system towards Th1ness
params = c(S1=1000, S2=1000, s1=2000, s2=2000, b1=80, b2=5, I12=10000, I21=10000, m=0.9, c1=50, c2=150, C1=50, C2=50, bp=4,Kp=300, a=0.006)
out3 <- ode(y=c(T1=200,T2=1,P=60), times=seq(0,40,0.1), full_model, params)

## Way #3: weaken chronicity-promoting feedbacks
params = c(S1=1000, S2=1000, s1=2000, s2=1500, b1=0.1, b2=0.1, I12=10000, I21=10000, m=0.9, c1=50, c2=150, C1=50, C2=50, bp=4,Kp=300, a=0.006)
out4 <- ode(y=c(T1=1,T2=1,P=60), times=seq(0,40,0.1), full_model, params)


par(mfrow=c(1,3), mar=c(2.5,5,1,1), oma=rep(0.5,4))
plot(out1[,c(1,4)], type='l', lwd=3, lty=2, col=gray(0.8), xlab='', ylab='', ylim=c(0,300), cex.axis=1.5)
mtext(side=2, line=3.5, "Parasite biomass", cex=1.5)
#lines(out2[,c(1,4)], lwd=3, col=gray(0.6))
lines(out3[,c(1,4)], lwd=3, col=gray(0.4))
lines(out4[,c(1,4)], lwd=3, col=gray(0))

plot(out1[,c(1,3)], type='l', lwd=3, lty=2, col=gray(0.8), xlab='', ylab='', ylim=c(0,1600), cex.axis=1.5)
mtext(side=2, line=3.5, "Th2 response", cex=1.5)
#lines(out2[,c(1,3)], lwd=3, col=gray(0.6))
lines(out3[,c(1,3)], lwd=3, col=gray(0.4))
lines(out4[,c(1,3)], lwd=3, col=gray(0))

plot(out1[,c(1,2)], type='l', lwd=3, lty=2, col=gray(0.8), xlab='', ylab='', ylim=c(0,1800), cex.axis=1.5)
mtext(side=2, line=3.5, "Th1 response", cex=1.5)
#lines(out2[,c(1,2)], lwd=3, col=gray(0.6))
lines(out3[,c(1,2)], lwd=3, col=gray(0.4))
lines(out4[,c(1,2)], lwd=3, col=gray(0))

